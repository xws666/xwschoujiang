<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å°ç¨³ç¥-æŠ½å¥–æ¨¡æ‹Ÿå™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: white;
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 60px;
      /* ä¸ºåº•éƒ¨å›ºå®šå…ƒç´ é¢„ç•™ç©ºé—´ */
      color: #333;
    }

    /* æ»¡å±æ–œå‘æ°´å°å±‚ï¼ˆå†…å®¹ä¸ºç™»å½•ç”¨æˆ·åï¼‰ */
    #watermarkLayer {
      position: fixed;
      inset: 0;
      z-index: 900;
      /* ä½äºå¯¼èˆªæ (1000)/åº•éƒ¨(999)ï¼Œé«˜äºå†…å®¹ */
      pointer-events: none;
      background-repeat: repeat;
      background-position: 0 0;
      /* å¹³é“ºå¯†åº¦ç”± JS é…ç½®åŠ¨æ€è®¾ç½® background-size */
      display: none;
      /* æœªç™»å½•æ—¶ä¸æ˜¾ç¤º */
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 0;
    }

    h1 {
      text-align: center;
      color: #000000;
      margin-bottom: 20px;
      font-size: 24px;
    }

    /* ç”¨æˆ·åè¾“å…¥åŒºåŸŸ */
    .username-section {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 400px;
      padding: 0;
    }

    .username-section input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      margin-bottom: 10px;
      background: white;
    }

    .username-section button {
      width: 100%;
      padding: 12px;
      background: #3b93ff;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .username-section button:hover {
      background: #5568d3;
    }

    .username-section button:active {
      transform: scale(0.98);
    }

    .username-section .tip {
      text-align: center;
      margin-top: 15px;
      color: #666666;
      font-size: 14px;
    }

    /* å¥–å“å±•ç¤ºåŒºåŸŸ */
    .prizes-section {
      margin-bottom: 20px;
    }

    .prizes-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .prize-item {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 4px;
      text-align: center;
      color: #333;
      font-weight: bold;
      border: 1px solid #e0e0e0;
    }

    .prize-item.highlight {
      background: #fff3cd;
      border-color: #ffc107;
      transform: scale(1.05);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1.05);
      }

      50% {
        transform: scale(1.1);
      }
    }

    /* æŠ½å¥–æŒ‰é’®åŒºåŸŸ */
    .draw-section {
      position: relative;
      /* margin-bottom: 10px; */
    }

    .probability-link {
      padding: 5px;
      position: absolute;
      left: 0;
      top: -25px;
      font-size: 14px;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
    }

    .probability-link:hover {
      color: #5568d3;
    }

    /* æŠ½å¥–æ¬¡æ•°ï¼ˆæŒ‰é’®ä¸Šæ–¹å³ä¾§ï¼‰ */
    .draw-info-top {
      padding: 5px;
      position: absolute;
      right: 0;
      top: -25px;
      font-size: 14px;
      color: #666;
      white-space: nowrap;
      user-select: none;
    }

    /* æŠ½å¥–æŒ‰é’® */
    .draw-button {
      margin: 0px 0px 10px 0px;
      width: 100%;
      padding: 10px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }

    .draw-button:hover:not(:disabled) {
      background: #5568d3;
    }

    .draw-button:active:not(:disabled) {
      background: #4a5bc4;
    }

    .draw-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    .draw-info {
      text-align: center;
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }

    /* è®°å½•é€‰é¡¹å¡ */
    .tabs {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: none;
      border: none;
      font-size: 16px;
      color: #666;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: bold;
    }

    /* è®°å½•åˆ—è¡¨ */
    .records-section {
      max-height: 400px;
      overflow-y: auto;
    }

    /* ç•™è¨€ */
    .message-panel {
      height: 400px;
      display: flex;
      flex-direction: column;
      border: 1px solid #eee;
      border-radius: 6px;
      background: #fff;
      overflow: hidden;
    }

    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px;
      background: #fafafa;
    }

    .message-card {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 5px 8px;
      /* margin-bottom: 10px; */
      margin-bottom: 10px;
      position: relative;
    }

    .message-meta {
      display: flex;
      gap: 8px;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .message-actions {
      position: absolute;
      top: 6px;
      right: 8px;
      display: flex;
      gap: 10px;
      font-size: 12px;
      align-items: center;
    }

    .message-action-btn {
      border: none;
      background: transparent;
      color: #667eea;
      cursor: pointer;
      padding: 2px 4px;
    }

    .message-action-btn.danger {
      color: #d33;
    }

    .message-user {
      font-weight: 800;
      color: #111;
      font-size: 14px;
      white-space: nowrap;
    }

    .message-time {
      font-size: 12px;
      color: #999;
      white-space: nowrap;
    }

    .message-text {
      font-size: 14px;
      color: #333;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* ç•™è¨€é£é™©æç¤ºæ»šåŠ¨æ¡ */
    .message-ticker {
      border-top: 1px solid #eee;
      background: #fff7e6;
      color: #8a5a00;
      font-size: 12px;
      line-height: 24px;
      height: 24px;
      overflow: hidden;
      white-space: nowrap;
      padding: 0 12px;
    }

    .message-ticker-track {
      display: inline-block;
      padding-left: 100%;
      animation: messageTickerScroll 18s linear infinite;
      will-change: transform;
    }

    .message-ticker:hover .message-ticker-track {
      animation-play-state: paused;
    }

    @keyframes messageTickerScroll {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-100%);
      }
    }

    .message-composer {
      display: flex;
      gap: 10px;
      padding: 10px 12px;
      border-top: 1px solid #eee;
      background: #fff;
    }

    .message-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }

    .message-send {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .message-send:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .record-item {
      padding: 8px 12px;
      margin-bottom: 10px;
      background: #f9f9f9;
      border-radius: 4px;
      border-left: 3px solid #bdbdbd;
      /* é»˜è®¤ï¼šéå½“å¤©ç°è‰² */
    }

    .record-item.is-today {
      border-left-color: #667eea;
      /* å½“å¤©ï¼šè“è‰² */
    }

    .record-item .record-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }

    .record-item .time {
      font-size: 14px;
      color: #999;
      white-space: nowrap;
    }

    .record-item .prize {
      font-size: 14px;
      font-weight: bold;
      color: #9e9e9e;
      /* é»˜è®¤ï¼šéå½“å¤©ç°è‰² */
      flex: 1;
    }

    .record-item.is-today .prize {
      color: #667eea;
      /* å½“å¤©ï¼šè“è‰² */
    }

    .record-item .username {
      font-size: 14px;
      color: #000;
      font-weight: bold;
      margin-right: 10px;
    }

    .empty-records {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    /* åŠ è½½æç¤º */
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    /* åº•éƒ¨ç‰ˆæƒä¿¡æ¯ */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      text-align: center;
      padding: 5px 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
      z-index: 999;
    }

    .footer .copyright {
      font-size: 14px;
      color: #999;
    }

    /* å¯¼èˆªæ  */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }

    .navbar .title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      position: relative;
    }

    .navbar .username {
      font-size: 16px;
      color: #667eea;
    }

    .navbar .switch-btn {
      padding: 5px 10px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      color: #666;
      cursor: pointer;
    }

    .navbar .switch-btn:hover {
      background: #e0e0e0;
    }

    /* é¡¶éƒ¨é€šçŸ¥/å…¬å‘Šæ»šåŠ¨æ¡ï¼ˆç´§è´´å¯¼èˆªæ ä¸‹æ–¹ï¼Œå›ºå®šåœ¨é¡µé¢é¡¶éƒ¨ï¼‰ */
    .site-ticker {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      background: #eaf2ff;
      color: #1b4b8a;
      font-size: 13px;
      line-height: 28px;
      height: 28px;
      overflow: hidden;
      white-space: nowrap;
      padding: 0 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .site-ticker-track {
      display: inline-block;
      padding-left: 100%;
      animation: siteTickerScroll 16s linear infinite;
      will-change: transform;
    }

    .site-ticker:hover .site-ticker-track {
      animation-play-state: paused;
    }

    @keyframes siteTickerScroll {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-100%);
      }
    }

    /* ä¸‹æ‹‰å¼¹çª— */
    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 10px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 200px;
      z-index: 1001;
      display: none;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-menu .menu-item {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 1px solid #f5f5f5;
      transition: background 0.2s;
    }

    .dropdown-menu .menu-item:last-child {
      border-bottom: none;
    }

    .dropdown-menu .menu-item:hover {
      background: #f5f5f5;
    }

    /* å¯†ç è¾“å…¥å¼¹çª— */
    .password-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .password-modal.show {
      display: flex;
    }

    .password-modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      /* height: 70%; */
    }

    .password-modal-content h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .password-modal-content input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      margin-bottom: 15px;
    }

    .password-modal-content .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .password-modal-content .modal-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }

    .password-modal-content .modal-buttons .confirm-btn {
      background: #667eea;
      color: white;
    }

    .password-modal-content .modal-buttons .cancel-btn {
      background: #f5f5f5;
      color: #666;
    }

    /* å…¬å‘Šå¼¹çª— */
    .notice-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      padding: 16px;
    }

    .notice-modal.show {
      display: flex;
    }

    .notice-modal-content {
      background: #fff;
      width: 100%;
      max-width: 520px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
    }

    .notice-modal-header {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
    }

    .notice-title {
      font-size: 18px;
      font-weight: 700;
      color: #111;
    }

    .notice-modal-body {
      padding: 14px 16px;
      max-height: 60vh;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 14px;
      color: #333;
    }

    .notice-modal-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      border-top: 1px solid #eee;
      background: #fff;
    }

    .notice-skip {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #555;
      font-size: 14px;
      user-select: none;
    }

    .notice-confirm-btn {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .notice-confirm-btn:active {
      background: #5568d3;
    }

    /* æ¦‚ç‡åˆ—è¡¨ */
    .probability-list {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .probability-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .probability-item:last-child {
      border-bottom: none;
    }

    .probability-item .prize-name {
      font-weight: bold;
      color: #333;
    }

    .probability-item .prize-probability {
      color: #667eea;
      font-weight: bold;
    }

    /* éšè—ç±» */
    .hidden {
      display: none;
    }

    /* ç®¡ç†å‘˜åå° */
    .admin-section {
      position: fixed;
      inset: 0;
      z-index: 1500;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .admin-section.hidden {
      display: none;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: #667eea;
      color: white;
      flex-shrink: 0;
    }

    .admin-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .admin-exit-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.25);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .admin-exit-btn:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    .admin-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 10px 16px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }

    .admin-tab {
      padding: 8px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
    }

    .admin-tab:hover {
      background: #f0f0f0;
    }

    .admin-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .admin-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .admin-tab-panel {
      display: none;
    }

    .admin-tab-panel.active {
      display: block;
    }

    .admin-hint {
      color: #666;
      font-size: 13px;
      margin-bottom: 12px;
    }

    .admin-form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
    }

    .admin-form-row input[type="text"],
    .admin-form-row input[type="number"] {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      min-width: 120px;
    }

    .admin-btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .admin-btn:hover {
      background: #5568d3;
    }

    .admin-btn.danger {
      background: #dc3545;
    }

    .admin-btn.danger:hover {
      background: #c82333;
    }

    /* åˆ—è¡¨ä¸­çš„æ–‡å­—æŒ‰é’®æ ·å¼ */
    .admin-link-btn {
      background: none;
      border: none;
      padding: 0;
      margin: 0 4px 0 0;
      font-size: 13px;
      cursor: pointer;
      color: #28a745;
      text-decoration: underline;
    }

    .admin-link-btn.danger {
      color: #dc3545;
    }

    .admin-link-btn:hover {
      opacity: 0.8;
    }

    .admin-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .admin-checkbox input {
      width: auto;
    }

    .admin-table-wrap {
      margin-top: 12px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .admin-table th,
    .admin-table td {
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      text-align: left;
    }

    .admin-table th {
      background: #f0f0f0;
    }

    .admin-prize-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 6px;
    }

    .admin-prize-row input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    .admin-prize-row .prize-name-inp {
      min-width: 80px;
    }

    .admin-prize-row .prize-prob-inp {
      width: 80px;
    }

    .admin-prize-row .prize-display-inp {
      min-width: 100px;
    }

    .preset-prize-select {
      min-width: 120px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <!-- æ»¡å±æ°´å°ï¼ˆç™»å½•åæ˜¾ç¤ºï¼Œå†…å®¹ä¸ºç”¨æˆ·åï¼‰ -->
  <div id="watermarkLayer" aria-hidden="true"></div>

  <div class="container">
    <!-- ç®¡ç†å‘˜å¼¹çª—å…¬å‘Šï¼ˆè¿›å…¥é¡µé¢æ—¶è‹¥å¯ç”¨åˆ™å¼¹å‡ºï¼‰ -->
    <div id="adminAnnouncementModal" class="notice-modal">
      <div class="notice-modal-content" onclick="event.stopPropagation()">
        <div class="notice-modal-header">
          <div class="notice-title">å…¬å‘Š</div>
        </div>
        <div id="adminAnnouncementContent" class="notice-modal-body"></div>
        <div class="notice-modal-footer">
          <button type="button" class="notice-confirm-btn" onclick="closeAdminAnnouncement()">çŸ¥é“äº†</button>
        </div>
      </div>
    </div>

    <!-- å…¬å‘Šå¼¹çª—ï¼ˆæ¯æ—¥é¦–æ¬¡è¿›å…¥å¼¹å‡ºï¼Œå¯å‹¾é€‰å½“æ—¥ä¸å†å¼¹å‡ºï¼‰ -->
    <div id="noticeModal" class="notice-modal">
      <div class="notice-modal-content" role="dialog" aria-modal="true" aria-labelledby="noticeTitle">
        <div class="notice-modal-header">
          <div id="noticeTitle" class="notice-title">å…¬å‘Š</div>
        </div>
        <div id="noticeContent" class="notice-modal-body"></div>
        <div class="notice-modal-footer">
          <label class="notice-skip">
            <input id="noticeSkipToday" type="checkbox" />
            ä»Šæ—¥ä¸å†å¼¹å‡º
          </label>
          <button class="notice-confirm-btn" onclick="agreeNotice()">åŒæ„å¹¶ç»§ç»­</button>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·åè¾“å…¥åŒºåŸŸ -->
    <div id="usernameSection" class="username-section">
      <h1>è¯·è®¾ç½®ä¸€ä¸ªç”¨æˆ·å</h1>
      <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·åï¼ˆé•¿åº¦1~6ä¸ªæ±‰å­—/å­—ç¬¦ï¼‰" maxlength="6"
        oninput="limitUsernameLength()">
      <button onclick="saveUsername()">ç™»å½•</button>
      <div class="tip">æ³¨æ„ï¼šç™»é™†åæ— æ³•é€€å‡ºï¼Œä¸”æ— æ³•ä¿®æ”¹ç”¨æˆ·åã€‚</div>
    </div>

    <!-- ä¸»æŠ½å¥–åŒºåŸŸ -->
    <div id="mainSection" class="hidden">
      <!-- å¯¼èˆªæ  -->
      <div class="navbar">
        <div class="title">å°ç¨³ç¥æŠ½å¥–</div>
        <div class="user-info" onclick="toggleDropdown()">
          <span class="username" id="displayUsername"></span>
          <span class="switch-btn">åˆ‡æ¢</span>
        </div>
        <!-- ä¸‹æ‹‰èœå• -->
        <div id="dropdownMenu" class="dropdown-menu">
          <div id="developerMenuItem" class="menu-item" onclick="openDeveloperMode()">å¼€å‘è€…äººå‘˜æ¨¡å¼</div>
          <div class="menu-item" onclick="openAdminPanel()">ç®¡ç†å‘˜åå°</div>
          <div id="exitDeveloperMenuItem" class="menu-item hidden" onclick="exitDeveloperMode()">è¿”å›ç”¨æˆ·</div>
        </div>
      </div>

      <!-- é¡¶éƒ¨å…¬å‘Šæ»šåŠ¨æ¡ï¼ˆå¯åç»­æ”¹ä¸ºé€šçŸ¥/å…¬å‘Šï¼‰ -->
      <div class="site-ticker" title="æç¤ºï¼šé¼ æ ‡æ‚¬åœå¯æš‚åœæ»šåŠ¨" role="status" aria-live="polite">
        <div class="site-ticker-track" id="siteTickerText">ç¥äºä¸–æ’ç”Ÿæ—¥å¿«ä¹ğŸ‚ï¼ç‰¹æ­¤èµ é€12æ¬¡æŠ½å¥–æœºä¼šï¼</div>
      </div>

      <!-- å¯†ç è¾“å…¥å¼¹çª— -->
      <div id="passwordModal" class="password-modal" onclick="closePasswordModal()">
        <div class="password-modal-content" onclick="event.stopPropagation()">
          <h3>è¯·è¾“å…¥å¼€å‘è€…å¯†ç </h3>
          <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç " maxlength="20"
            onkeypress="if(event.key==='Enter') checkPassword()">
          <div class="modal-buttons">
            <button class="confirm-btn" onclick="checkPassword()">ç¡®è®¤</button>
            <button class="cancel-btn" onclick="closePasswordModal()">å–æ¶ˆ</button>
          </div>
        </div>
      </div>

      <!-- ç®¡ç†å‘˜å¯†ç å¼¹çª— -->
      <div id="adminPasswordModal" class="password-modal" onclick="closeAdminPasswordModal()">
        <div class="password-modal-content" onclick="event.stopPropagation()">
          <h3>è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </h3>
          <input type="password" id="adminPasswordInput" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " maxlength="20"
            onkeypress="if(event.key==='Enter') checkAdminPassword()">
          <div class="modal-buttons">
            <button class="confirm-btn" onclick="checkAdminPassword()">ç¡®è®¤</button>
            <button class="cancel-btn" onclick="closeAdminPasswordModal()">å–æ¶ˆ</button>
          </div>
        </div>
      </div>

      <!-- æ¦‚ç‡å±•ç¤ºå¼¹çª— -->
      <div id="probabilityModal" class="password-modal" onclick="closeProbabilityModal()">
        <div class="password-modal-content" onclick="event.stopPropagation()">
          <h3>å¥–é¡¹æ¦‚ç‡ï¼ˆéšæ—¶è°ƒæ•´è¯·ç•™æ„ï¼‰</h3>
          <div id="probabilityList" class="probability-list"></div>
          <div class="modal-buttons">
            <button class="cancel-btn" onclick="closeProbabilityModal()" style="width: 100%;">å…³é—­</button>
          </div>
        </div>
      </div>

      <!-- ç•™è¨€ç¼–è¾‘å¼¹çª—ï¼ˆä»…â€œå°ç¨³ç¥â€å¯è§æ“ä½œå…¥å£ï¼‰ -->
      <div id="messageEditModal" class="password-modal" onclick="closeMessageEditModal()">
        <div class="password-modal-content" onclick="event.stopPropagation()">
          <h3>ç¼–è¾‘ç•™è¨€</h3>
          <input type="hidden" id="messageEditId" />
          <textarea id="messageEditText"
            style="width:100%;min-height:120px;resize:vertical;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;line-height:1.5;margin-bottom:15px;"></textarea>
          <div class="modal-buttons">
            <button class="confirm-btn" onclick="saveMessageEdit()">ä¿å­˜</button>
            <button class="cancel-btn" onclick="closeMessageEditModal()">å–æ¶ˆ</button>
          </div>
        </div>
      </div>

      <!-- å¥–å“å±•ç¤º -->
      <div class="prizes-section">
        <div class="prizes-grid" id="prizesGrid">
          <div class="prize-item">520å…ƒ</div>
          <div class="prize-item">100å…ƒ</div>
          <div class="prize-item">52å…ƒ</div>
          <div class="prize-item">10å…ƒ</div>
          <div class="prize-item">1å…ƒ</div>
          <div class="prize-item">0.52å…ƒ</div>
          <div class="prize-item">0.1å…ƒ</div>
          <div class="prize-item">0.01å…ƒ</div>
          <!--<div class="prize-item">è°¢è°¢å‚ä¸</div>-->
        </div>
      </div>

      <!-- æŠ½å¥–æŒ‰é’®åŒºåŸŸ -->
      <div class="draw-section">
        <div class="probability-link" onclick="showProbabilityModal()">æŸ¥çœ‹æ¦‚ç‡</div>
        <div class="draw-info-top" id="drawInfo">ä»Šæ—¥å‰©ä½™æŠ½å¥–æ¬¡æ•°: <span id="remainingCount">5</span> æ¬¡</div>
        <button id="drawButton" class="draw-button" onclick="drawPrize()">æŠ½å¥–</button>
      </div>

      <!-- è®°å½•é€‰é¡¹å¡ -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('my')">æˆ‘çš„è®°å½•</button>
        <button class="tab" onclick="switchTab('all')">ä»–äººè®°å½•</button>
        <button class="tab" onclick="switchTab('msg')">ç•™è¨€</button>
      </div>

      <!-- è®°å½•åˆ—è¡¨ -->
      <div id="recordsPanel" class="records-section">
        <div id="myRecords" class="records-list">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        <div id="allRecords" class="records-list hidden">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>

      <!-- ç•™è¨€é¢æ¿ -->
      <div id="messagePanel" class="message-panel hidden">
        <div id="messageList" class="message-list">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        <div class="message-ticker" title="æç¤ºï¼šé¼ æ ‡æ‚¬åœå¯æš‚åœæ»šåŠ¨">
          <div class="message-ticker-track">
            ä¸¥ç¦å‘å¸ƒè¿æ³•è¿è§„ã€æ¶‰é»„æ¶‰èµŒã€æš´åŠ›è¾±éª‚åŠä»»ä½•ä¸å½“è¨€è®ºï¼›è¯·æ–‡æ˜å‘è¨€ï¼Œè¿è€…å°†åˆ é™¤å†…å®¹å¹¶å°ç¦è´¦å·ï¼Œå¿…è¦æ—¶é…åˆç›¸å…³éƒ¨é—¨å¤„ç†ã€‚
          </div>
        </div>
        <div class="message-composer">
          <input id="messageInput" class="message-input" type="text" placeholder="è¯·è¾“å…¥ç•™è¨€â€¦" maxlength="200" />
          <button id="messageSendBtn" class="message-send" onclick="sendMessage()">å‘é€</button>
        </div>
      </div>
    </div>

    <!-- ç®¡ç†å‘˜åå°ï¼ˆå…¨å±ï¼‰ -->
    <div id="adminSection" class="admin-section hidden">
      <div class="admin-header">
        <h2>ç®¡ç†å‘˜åå°</h2>
        <button type="button" class="admin-exit-btn" onclick="exitAdminPanel()">é€€å‡ºç®¡ç†å‘˜</button>
      </div>
      <div class="admin-tabs">
        <button type="button" class="admin-tab active" data-tab="quota">æŠ½å¥–æ¬¡æ•°</button>
        <button type="button" class="admin-tab" data-tab="winnings">ä¸­å¥–æ±‡æ€»</button>
        <button type="button" class="admin-tab" data-tab="prizes">å¥–é¡¹æ¦‚ç‡</button>
        <button type="button" class="admin-tab" data-tab="preset">é¢„è®¾å¥–é¡¹</button>
        <button type="button" class="admin-tab" data-tab="records">è®°å½•ç®¡ç†</button>
      </div>
      <div class="admin-content">
        <!-- æŠ½å¥–æ¬¡æ•° -->
        <div id="adminTabQuota" class="admin-tab-panel active">
          <p class="admin-hint">è®¾ç½®æŒ‡å®šç”¨æˆ·ä»Šæ—¥å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼ˆè¦†ç›–æŒ‰è®°å½•è®¡ç®—çš„æ¬¡æ•°ï¼‰</p>
          <div class="admin-form-row">
            <input type="text" id="adminQuotaUsername" placeholder="ç”¨æˆ·å" maxlength="20" />
            <input type="number" id="adminQuotaRemaining" placeholder="å‰©ä½™æ¬¡æ•°" min="0" />
            <button type="button" class="admin-btn" onclick="adminSaveQuota()">ä¿å­˜</button>
          </div>
        </div>
        <!-- ä¸­å¥–æ±‡æ€» -->
        <div id="adminTabWinnings" class="admin-tab-panel">
          <p class="admin-hint">ä»Šæ—¥ä¸­å¥–é‡‘é¢ä¸å†å²æ€»ä¸­å¥–é‡‘é¢ï¼ˆæŒ‰ç”¨æˆ·æ±‡æ€»ï¼‰</p>
          <button type="button" class="admin-btn" onclick="adminLoadWinnings()">åˆ·æ–°æ±‡æ€»</button>
          <div id="adminWinningsList" class="admin-table-wrap"></div>
        </div>
        <!-- å¥–é¡¹æ¦‚ç‡ -->
        <div id="adminTabPrizes" class="admin-tab-panel">
          <p class="admin-hint">ä¿®æ”¹å¥–é¡¹åç§°ã€çœŸå®æ¦‚ç‡ï¼ˆ0~1 å°æ•°ï¼‰å’Œå±•ç¤ºæ¦‚ç‡ï¼ˆä»»æ„å­—ç¬¦ä¸²ï¼‰</p>
          <div id="adminPrizesList"></div>
          <button type="button" class="admin-btn" onclick="adminSavePrizes()">ä¿å­˜å¥–é¡¹é…ç½®</button>
        </div>
        <!-- é¢„è®¾å¥–é¡¹ -->
        <div id="adminTabPreset" class="admin-tab-panel">
          <p class="admin-hint">ä¸ºæŒ‡å®šç”¨æˆ·é¢„è®¾æ¥ä¸‹æ¥æœ€å¤š 5 æ¬¡æŠ½å¥–è¦ä¸­çš„å¥–é¡¹ï¼ˆä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ç”Ÿæ•ˆï¼‰</p>
          <div class="admin-form-row">
            <input type="text" id="adminPresetUsername" placeholder="ç”¨æˆ·å" maxlength="20" />
          </div>
          <div class="admin-form-row" id="adminPresetPrizesRow">
            <select class="preset-prize-select"></select>
            <select class="preset-prize-select"></select>
            <select class="preset-prize-select"></select>
            <select class="preset-prize-select"></select>
            <select class="preset-prize-select"></select>
          </div>
          <button type="button" class="admin-btn" onclick="adminSavePresetPrizes()">ä¿å­˜é¢„è®¾å¥–é¡¹</button>
          <div class="admin-hint" style="margin-top:14px;">å½“å‰é¢„è®¾åˆ—è¡¨ï¼ˆå¯éšæ—¶ä¿®æ”¹æˆ–åˆ é™¤ï¼‰ï¼š</div>
          <div id="adminPresetList" class="admin-table-wrap"></div>
        </div>
        <!-- è®°å½•ç®¡ç† -->
        <div id="adminTabRecords" class="admin-tab-panel">
          <p class="admin-hint">æŸ¥çœ‹/åˆ é™¤/ä¿®æ”¹æ¯æ¡æŠ½å¥–è®°å½•</p>
          <input type="text" id="adminRecordsUsername" placeholder="æŒ‰ç”¨æˆ·åç­›é€‰ï¼ˆç•™ç©ºä¸ºå…¨éƒ¨ï¼‰" />
          <button type="button" class="admin-btn" onclick="adminLoadRecords()">åŠ è½½è®°å½•</button>
          <div id="adminRecordsList" class="admin-table-wrap"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç‰ˆæƒä¿¡æ¯ -->
  <div class="footer">
    <div class="copyright">Beta-v1.0.4 | åé¦ˆQQé‚®ç®±ï¼š3253952854@qq.com</div>
  </div>

  <!-- LeanCloud SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>

  <script>
    // LeanCloud é…ç½® - éœ€è¦æ›¿æ¢ä¸ºæ‚¨çš„å®é™… AppID å’Œ AppKey
    const APP_ID = 'Em8tisJ7TQ49O0TapPHhuCLy-gzGzoHsz';
    const APP_KEY = 'C9q5IAIPSwhId23glTf8g8eg';

    // åˆå§‹åŒ– LeanCloud
    try {
      AV.init({
        appId: APP_ID,
        appKey: APP_KEY,
        serverURL: 'https://em8tisj7.lc-cn-n1-shared.com' // å›½å†…ç‰ˆéœ€è¦è®¾ç½®æ­¤å‚æ•°
      });
      console.log('LeanCloud åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      console.error('LeanCloud åˆå§‹åŒ–å¤±è´¥:', error);
      alert('LeanCloud é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥ AppID å’Œ AppKey');
    }

    // å…¨å±€å˜é‡
    let currentUsername = '';
    let todayDrawCount = 0;
    const MAX_DAILY_DRAWS = 5;
    let isDeveloperMode = false;
    const DEVELOPER_PASSWORD = '475397';
    const ADMIN_PASSWORD = '397520';
    let isAdminMode = false;
    let currentDateString = ''; // ç”¨äºæ£€æµ‹è·¨å¤©
    let dateCheckInterval = null; // è·¨å¤©æ£€æµ‹å®šæ—¶å™¨

    let PRIZES = [
      { name: '520å…ƒ', probability: 0 / 100, displayProbability: "0.000008%" },
      { name: '100å…ƒ', probability: 0 / 100, displayProbability: "0.00008%" },
      { name: '52å…ƒ', probability: 0 / 100, displayProbability: "0.008%" },
      { name: '10å…ƒ', probability: 0 / 100, displayProbability: "1.8%" },
      { name: '1å…ƒ', probability: 0.8 / 100, displayProbability: "8.8%" },
      { name: '0.52å…ƒ', probability: 1.8 / 100, displayProbability: "18.8%" },
      { name: '0.1å…ƒ', probability: 12.8 / 100, displayProbability: "28.8%" },
      { name: '0.01å…ƒ', probability: 38 / 100, displayProbability: "48%" },

    ];


    // AppConfigï¼šä» LeanCloud è¯»å–/å†™å…¥å…¨å±€é…ç½®ï¼ˆkey/value å­—ç¬¦ä¸²ï¼‰
    async function getAppConfig(key) {
      try {
        const Config = AV.Object.extend('AppConfig');
        const query = new AV.Query(Config);
        query.equalTo('key', key);
        const result = await query.first();
        return result ? result.get('value') : null;
      } catch (e) {
        console.error('getAppConfig error:', e);
        return null;
      }
    }

    async function setAppConfig(key, value) {
      try {
        const Config = AV.Object.extend('AppConfig');
        const query = new AV.Query(Config);
        query.equalTo('key', key);
        let obj = await query.first();
        if (!obj) {
          obj = new Config();
          obj.set('key', key);
        }
        obj.set('value', value);
        await obj.save();
        return true;
      } catch (e) {
        console.error('setAppConfig error:', e);
        return false;
      }
    }

    // DrawQuotaOverrideï¼ˆLeanCloudï¼‰ï¼šæ¯äººæ¯æ—¥å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼Œæ¬¡æ—¥ 0 ç‚¹æ— è®°å½•åˆ™è§†ä¸ºæ–°ä¸€å¤©é‡ç½®ä¸º 5 æ¬¡
    async function getDrawCountRecord(username, drawDate) {
      try {
        const Quota = AV.Object.extend('DrawQuotaOverride');
        const query = new AV.Query(Quota);
        query.equalTo('username', username);
        query.equalTo('drawDate', drawDate);
        return await query.first();
      } catch (e) {
        console.error('getDrawCountRecord error:', e);
        return null;
      }
    }

    async function createDrawCountRecord(username, drawDate, remainingCount) {
      try {
        const Quota = AV.Object.extend('DrawQuotaOverride');
        const obj = new Quota();
        obj.set('username', username);
        obj.set('drawDate', drawDate);
        obj.set('remainingCount', remainingCount);
        await obj.save();
        return obj;
      } catch (e) {
        console.error('createDrawCountRecord error:', e);
        return null;
      }
    }

    /** è·å–ä»Šæ—¥å‰©ä½™æ¬¡æ•°ï¼ˆæ— è®°å½•åˆ™åˆ›å»ºä¸º 5 æ¬¡ï¼Œå³æ¬¡æ—¥é‡ç½®ï¼‰ */
    async function getOrSetTodayRemaining(username) {
      const today = getTodayString();
      let record = await getDrawCountRecord(username, today);
      if (!record) {
        record = await createDrawCountRecord(username, today, MAX_DAILY_DRAWS);
        return record ? record.get('remainingCount') : MAX_DAILY_DRAWS;
      }
      return record.get('remainingCount');
    }

    async function getDrawQuotaOverride(username, drawDate) {
      const record = await getDrawCountRecord(username, drawDate);
      return record ? record.get('remainingCount') : null;
    }

    async function setDrawQuotaOverride(username, drawDate, remainingCount) {
      try {
        const today = getTodayString();
        let record = await getDrawCountRecord(username, drawDate);
        if (!record) {
          record = await createDrawCountRecord(username, drawDate, remainingCount);
          return !!record;
        }
        record.set('remainingCount', Math.max(0, parseInt(remainingCount, 10)));
        await record.save();
        return true;
      } catch (e) {
        console.error('setDrawQuotaOverride error:', e);
        return false;
      }
    }

    // æ ¹æ®å¥–å“åç§°è§£æé‡‘é¢ï¼ˆå…ƒï¼‰
    function parsePrizeToYuan(prizeName) {
      if (!prizeName || prizeName === 'è°¢è°¢å‚ä¸') return 0;
      const m = String(prizeName).match(/([\d.]+)\s*å…ƒ/);
      return m ? parseFloat(m[1]) || 0 : 0;
    }

    // ç”¨ PRIZES æ¸²æŸ“å¥–å“ç½‘æ ¼
    function renderPrizesGrid() {
      const grid = document.getElementById('prizesGrid');
      if (!grid) return;
      grid.innerHTML = '';
      PRIZES.forEach((p) => {
        const div = document.createElement('div');
        div.className = 'prize-item';
        div.textContent = p.name;
        grid.appendChild(div);
      });
    }

    // åŠ è½½ç®¡ç†å‘˜é…ç½®åˆ°ä¸»é¡µé¢ï¼ˆå¥–å“ã€æ»šåŠ¨æ¡ã€å¼¹çª—å…¬å‘Šï¼‰
    async function loadAdminConfig() {
      try {
        const prizesJson = await getAppConfig('prizes');
        if (prizesJson) {
          const arr = JSON.parse(prizesJson);
          if (Array.isArray(arr) && arr.length > 0) PRIZES = arr;
          renderPrizesGrid();
        }
        const tickerText = await getAppConfig('tickerText');
        const tickerEl = document.getElementById('siteTickerText');
        if (tickerEl && tickerText != null && tickerText !== '') tickerEl.textContent = tickerText;
        const annJson = await getAppConfig('announcement');
        if (annJson) {
          const ann = JSON.parse(annJson);
          if (ann && ann.enabled && ann.content && document.getElementById('adminAnnouncementModal')) {
            document.getElementById('adminAnnouncementContent').textContent = ann.content;
            document.getElementById('adminAnnouncementModal').classList.add('show');
          }
        }
      } catch (e) {
        console.error('loadAdminConfig error:', e);
      }
    }

    function closeAdminAnnouncement() {
      const modal = document.getElementById('adminAnnouncementModal');
      if (modal) modal.classList.remove('show');
    }

    // æ£€æµ‹æ˜¯å¦è·¨å¤©ï¼Œå¦‚æœè·¨å¤©åˆ™é‡ç½®æŠ½å¥–æ¬¡æ•°
    function checkDateChange() {
      const today = getTodayString();
      if (currentDateString && currentDateString !== today) {
        // è·¨å¤©äº†ï¼Œé‡ç½®æŠ½å¥–æ¬¡æ•°
        console.log('æ£€æµ‹åˆ°è·¨å¤©ï¼Œé‡ç½®æŠ½å¥–æ¬¡æ•°');
        todayDrawCount = 0;
        currentDateString = today;
        if (!isDeveloperMode) {
          loadTodayDrawCount();
        }
      } else if (!currentDateString) {
        // é¦–æ¬¡è®¾ç½®
        currentDateString = today;
      }
    }

    // å¯åŠ¨è·¨å¤©æ£€æµ‹å®šæ—¶å™¨ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
    function startDateCheckTimer() {
      // æ¸…é™¤å·²æœ‰å®šæ—¶å™¨
      if (dateCheckInterval) {
        clearInterval(dateCheckInterval);
      }
      // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
      checkDateChange();
      // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
      dateCheckInterval = setInterval(checkDateChange, 60000); // 60000ms = 1åˆ†é’Ÿ
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç”¨æˆ·åå’Œå¼€å‘è€…æ¨¡å¼
    window.onload = function () {
      maybeShowNotice();
      const savedUsername = localStorage.getItem('username');
      const savedDeveloperMode = localStorage.getItem('isDeveloperMode');
      if (savedUsername) {
        currentUsername = savedUsername;
        updateWatermark(currentUsername);
        if (savedDeveloperMode === 'true') {
          isDeveloperMode = true;
        }
        showMainSection();
        loadAdminConfig(); // åŠ è½½ç®¡ç†å‘˜é…ç½®ï¼šå¥–å“ã€æ»šåŠ¨æ¡ã€å¼¹çª—å…¬å‘Š
        currentDateString = getTodayString();
        startDateCheckTimer();
        loadTodayDrawCount();
        loadRecords('my');
      }
    };

    // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ£€æµ‹è·¨å¤©ï¼ˆç”¨æˆ·ä»å…¶ä»–æ ‡ç­¾é¡µåˆ‡å›æ¥æ—¶ï¼‰
    document.addEventListener('visibilitychange', function () {
      if (!document.hidden && currentUsername) {
        // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œç«‹å³æ£€æŸ¥æ˜¯å¦è·¨å¤©
        checkDateChange();
      }
    });

    // ============================
    // æ°´å°é…ç½®ï¼ˆå¯é€šè¿‡ä»£ç è‡ªç”±ä¿®æ”¹ï¼‰
    // ============================
    // è¯´æ˜ï¼š
    // - fontSize: å­—ä½“å¤§å°(px)
    // - gapX/gapY: æ°´å°æ°´å¹³/å‚ç›´é—´è·(px)ï¼Œè¶Šå°è¶Šå¯†
    // - angleDeg: æ—‹è½¬è§’åº¦(åº¦)ï¼Œä¾‹å¦‚ -30
    // - color: é¢œè‰²(r,g,b)
    // - alpha: é€æ˜åº¦(0~1)
    const WATERMARK_CONFIG = {
      fontSize: 14,
      gapX: 180,
      gapY: 200,
      angleDeg: -30,
      color: { r: 0, g: 0, b: 0 },
      alpha: 0.12,
      fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif",
    };

    // å¯æ‰‹åŠ¨è°ƒç”¨ï¼šä¿®æ”¹ WATERMARK_CONFIG åæ‰§è¡Œ refreshWatermark()
    function refreshWatermark() {
      updateWatermark(currentUsername);
    }

    // è·å–æœ¬åœ°æ—¥æœŸ YYYYMMDDï¼ˆé¿å… toISOString çš„æ—¶åŒºè·¨å¤©é—®é¢˜ï¼‰
    function getTodayCompactLocal() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}${m}${day}`;
    }

    // ç”Ÿæˆå¹¶æ›´æ–°æ°´å°ï¼ˆç”¨ Canvas ç”Ÿæˆå¯é‡å¤èƒŒæ™¯ï¼‰
    function updateWatermark(text) {
      const layer = document.getElementById('watermarkLayer');
      if (!layer) return;
      const t = (text || '').trim();
      if (!t) {
        layer.style.backgroundImage = '';
        layer.style.backgroundSize = '';
        layer.style.display = 'none';
        return;
      }

      // æ°´å°å†…å®¹ï¼šç”¨æˆ·å + ä»Šæ—¥æ—¥æœŸï¼ˆYYYYMMDDï¼‰
      const watermarkText = `${t}${getTodayCompactLocal()}`;

      const canvas = document.createElement('canvas');
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const w = Math.max(120, WATERMARK_CONFIG.gapX) * dpr;
      const h = Math.max(90, WATERMARK_CONFIG.gapY) * dpr;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      ctx.clearRect(0, 0, w, h);
      ctx.save();
      ctx.translate(w / 2, h / 2);
      ctx.rotate((WATERMARK_CONFIG.angleDeg * Math.PI) / 180);
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const { r, g, b } = WATERMARK_CONFIG.color;
      ctx.fillStyle = `rgba(${r},${g},${b},${WATERMARK_CONFIG.alpha})`;
      ctx.font = `${WATERMARK_CONFIG.fontSize * dpr}px ${WATERMARK_CONFIG.fontFamily}`;
      ctx.fillText(watermarkText, 0, 0);
      ctx.restore();

      layer.style.backgroundImage = `url(${canvas.toDataURL('image/png')})`;
      layer.style.backgroundSize = `${WATERMARK_CONFIG.gapX}px ${WATERMARK_CONFIG.gapY}px`;
      layer.style.display = 'block';
    }

    // ============================
    // å…¬å‘Šå¼¹çª—ï¼ˆæ¯æ—¥ä¸€æ¬¡ï¼‰
    // ============================
    const NOTICE_SKIP_KEY = 'notice_skip_date_v1';

    function getNoticeText() {
      return `
ä½¿ç”¨é¡»çŸ¥ï¼š
1.åˆ‡å‹¿é€ å‡ï¼Œå‘ç°åå°†å°ç¦æµ‹è¯•è´¦å·ã€‚æµ‹è¯•ç”¨æˆ·èµ„æ ¼å‘æ”¾æœ‰é™ï¼Œä»…å‰ä¸‰å¤©å¯å‚ä¸å…‘å¥–ã€‚è¯·åœ¨å½“æ—¥24ï¼š00å‰å…‘å¥–ã€‚
2.æœ¬APPæ‰¿è¯ºä¸è·å–ã€ä¸æ”¶é›†ã€ä¸å­˜å‚¨ç”¨æˆ·éšç§ä¿¡æ¯ï¼Œä¹Ÿä¸ä¼šå‘ä»»ä½•ç¬¬ä¸‰æ–¹æä¾›æˆ–å‡ºå”®ä»»ä½•ç”¨æˆ·æ•°æ®ã€‚
3.æœªç»è®¸å¯ï¼Œç¦æ­¢å¯¹æœ¬åº”ç”¨è¿›è¡Œåç¼–è¯‘ã€ç ´è§£ã€ç¯¡æ”¹æˆ–è¿›è¡Œä»»ä½•å½¢å¼çš„é€†å‘å·¥ç¨‹ã€‚
4.æŠ½å¥–ä¸ºæ¦‚ç‡æ€§æ´»åŠ¨ï¼Œå¼€å¥–ç»“æœä»¥ç³»ç»Ÿå…¬ç¤ºç»“æœä¸ºå‡†ã€‚
5.æœ¬æ´»åŠ¨/æŠ½å¥–ç”±æœ¬APPå¼€å‘è€…ä¸»åŠå¹¶è´Ÿè´£è§£é‡Šä¸æ‰§è¡Œï¼Œå¦‚å‘ç°å®‰å…¨æ¼æ´æˆ–å¼‚å¸¸è¡Œä¸ºåé¦ˆè‡³3253952854@qq.comï¼Œæˆ‘ä»¬å°†åŠæ—¶å¤„ç†ã€‚
6.æœ¬æ¡æ¬¾æœªå°½äº‹å®œä»¥æœ€æ–°ã€Šç”¨æˆ·åè®®ã€‹ä¸ã€ŠæœåŠ¡è§„åˆ™ã€‹ä¸ºå‡†ï¼Œå¹¶é€‚ç”¨ç›¸å…³æ³•å¾‹æ³•è§„ã€‚
7.ä½¿ç”¨åˆ™ä»£è¡¨æ‚¨ä»¥ä»”ç»†é˜…è¯»å¹¶åŒæ„!`;
    }

    function maybeShowNotice() {
      const modal = document.getElementById('noticeModal');
      const content = document.getElementById('noticeContent');
      if (!modal || !content) return;

      const today = getTodayString();
      const skipped = localStorage.getItem(NOTICE_SKIP_KEY);
      if (skipped === today) return;

      content.textContent = getNoticeText();
      modal.classList.add('show');
    }

    function agreeNotice() {
      const modal = document.getElementById('noticeModal');
      const checkbox = document.getElementById('noticeSkipToday');
      if (!modal) return;

      if (checkbox && checkbox.checked) {
        localStorage.setItem(NOTICE_SKIP_KEY, getTodayString());
      }
      modal.classList.remove('show');
    }

    function limitUsernameLength() {
      const input = document.getElementById('usernameInput');
      if (!input) return;
      const v = input.value || '';
      if (v.length > 6) input.value = v.slice(0, 6);
    }

    // ä¿å­˜ç”¨æˆ·å
    async function saveUsername() {
      limitUsernameLength();
      const username = document.getElementById('usernameInput').value.trim();
      if (!username) {
        alert('è¯·è¾“å…¥ç”¨æˆ·å');
        return;
      }
      if (username.length > 6) {
        alert('ç”¨æˆ·åæœ€å¤š6ä¸ªå­—'); return;
      }

      currentUsername = username;
      localStorage.setItem('username', username);
      updateWatermark(currentUsername);
      showMainSection();
      await loadTodayDrawCount();
      await loadRecords('my');
    }

    // æ˜¾ç¤ºä¸»æŠ½å¥–åŒºåŸŸ
    function showMainSection() {
      document.getElementById('usernameSection').classList.add('hidden');
      document.getElementById('mainSection').classList.remove('hidden');
      updateNavbarDisplay();
      // ä¸ºå¯¼èˆªæ  + é¡¶éƒ¨å…¬å‘Šæ¡é¢„ç•™é¡¶éƒ¨é—´è·
      document.getElementById('mainSection').style.paddingTop = '90px';
    }

    // æ›´æ–°å¯¼èˆªæ æ˜¾ç¤º
    function updateNavbarDisplay() {
      const displayUsername = document.getElementById('displayUsername');
      const developerMenuItem = document.getElementById('developerMenuItem');
      const exitDeveloperMenuItem = document.getElementById('exitDeveloperMenuItem');

      if (isDeveloperMode) {
        displayUsername.textContent = 'å¼€å‘è€…';
        developerMenuItem.classList.add('hidden');
        exitDeveloperMenuItem.classList.remove('hidden');
      } else {
        displayUsername.textContent = currentUsername;
        developerMenuItem.classList.remove('hidden');
        exitDeveloperMenuItem.classList.add('hidden');
      }
    }

    // åŠ è½½ä»Šæ—¥æŠ½å¥–æ¬¡æ•°ï¼ˆä» LeanCloud è¯»å–ï¼Œæ— è®°å½•åˆ™åˆ›å»ºä¸º 5 æ¬¡ï¼Œæ¬¡æ—¥ 0 ç‚¹è‡ªç„¶é‡ç½®ï¼‰
    async function loadTodayDrawCount() {
      try {
        const drawButton = document.getElementById('drawButton');
        if (isDeveloperMode) {
          document.getElementById('remainingCount').textContent = 'âˆ';
          drawButton.disabled = false;
          document.getElementById('drawInfo').textContent = 'å¼€å‘è€…æ¨¡å¼ï¼šæ— é™æ¬¡æŠ½å¥–';
          return;
        }

        checkDateChange();
        const remaining = await getOrSetTodayRemaining(currentUsername);
        const n = Math.max(0, parseInt(remaining, 10));
        todayDrawCount = MAX_DAILY_DRAWS - n;

        document.getElementById('remainingCount').textContent = n;
        drawButton.disabled = n <= 0;
        document.getElementById('drawInfo').textContent = `ä»Šæ—¥å‰©ä½™æŠ½å¥–æ¬¡æ•°: ${n} æ¬¡`;
      } catch (error) {
        console.error('åŠ è½½æŠ½å¥–æ¬¡æ•°å¤±è´¥:', error);
      }
    }

    // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼Œä½¿ç”¨æœ¬åœ°æ—¶åŒºï¼‰
    function getTodayString() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // è·å–æŒ‡å®šæ—¥æœŸçš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼Œæœ¬åœ°æ—¶åŒºï¼‰
    function getDateStringFromDate(date) {
      const d = date instanceof Date ? date : new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // æ ¼å¼åŒ–æ—¶é—´ï¼ˆå¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’ï¼‰
    function formatDateTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // æŠ½å¥–é€»è¾‘
    async function drawPrize() {
      if (!isDeveloperMode && todayDrawCount >= MAX_DAILY_DRAWS) {
        alert('ä»Šæ—¥æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·æ˜å¤©å†æ¥ï¼');
        return;
      }

      // ç¦ç”¨æŒ‰é’®
      const drawButton = document.getElementById('drawButton');
      drawButton.disabled = true;
      drawButton.textContent = 'æŠ½å¥–ä¸­...';

      const prizeItems = document.querySelectorAll('.prize-item');

      // å°è¯•ä»â€œé¢„è®¾å¥–é¡¹é˜Ÿåˆ—â€ä¸­å–å‡ºä¸‹ä¸€æ¬¡è¦ä¸­çš„å¥–é¡¹åç§°ï¼ˆå¦‚æ— åˆ™è¿”å› nullï¼‰
      async function getNextPrizeForUser() {
        try {
          const Plan = AV.Object.extend('UserPrizePlan');
          const query = new AV.Query(Plan);
          query.equalTo('username', currentUsername);
          const obj = await query.first();
          if (!obj) return null;
          const raw = obj.get('prizesJson') || '[]';
          let arr;
          try {
            arr = JSON.parse(raw);
          } catch {
            arr = [];
          }
          if (!Array.isArray(arr) || arr.length === 0) {
            await obj.destroy();
            return null;
          }
          const nextName = arr.shift();
          if (arr.length === 0) {
            await obj.destroy();
          } else {
            obj.set('prizesJson', JSON.stringify(arr));
            await obj.save();
          }
          if (!nextName) return null;
          return nextName;
        } catch (e) {
          // 404 è¡¨ç¤ºè¡¨ä¸å­˜åœ¨ï¼Œè§†ä¸ºæ— é¢„è®¾
          if (e.code === 404 || e.status === 404) return null;
          console.error('getNextPrizeForUser error:', e);
          return null;
        }
      }

      if (isDeveloperMode) {
        // å¼€å‘è€…æ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºç»“æœï¼Œæ— åŠ¨ç”»
        const plannedName = await getNextPrizeForUser();
        const prize = plannedName ? { name: plannedName } : calculatePrize();

        // é«˜äº®æ˜¾ç¤ºä¸­å¥–é¡¹
        prizeItems.forEach((item) => {
          item.classList.remove('highlight');
          if (item.textContent === prize.name) {
            item.classList.add('highlight');
          }
        });

        // ä¿å­˜è®°å½•åˆ° LeanCloud
        const saveSuccess = await saveDrawRecord(prize.name);

        // å¼€å‘è€…æ¨¡å¼ï¼šç«‹å³æ¢å¤æŒ‰é’®å¯ç”¨
        drawButton.disabled = false;
        drawButton.textContent = 'æŠ½å¥–';

        // å¦‚æœä¿å­˜æˆåŠŸï¼Œé‡æ–°åŠ è½½è®°å½•
        if (saveSuccess) {
          await loadRecords('my');
        }

        // çŸ­æš‚æ˜¾ç¤ºé«˜äº®åæ¸…é™¤
        setTimeout(() => {
          prizeItems.forEach(item => item.classList.remove('highlight'));
        }, 500);
      } else {
        // ç”¨æˆ·æ¨¡å¼ï¼šæœ‰åŠ¨ç”»ï¼Œæ—¶é—´ç¼©çŸ­
        // å…ˆè·å–é¢„è®¾å¥–é¡¹ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œä»¥ä¾¿åœ¨åŠ¨ç”»ç»“æŸæ—¶ç›´æ¥è·³åˆ°é¢„è®¾å¥–é¡¹
        const plannedName = await getNextPrizeForUser();
        const hasPlannedPrize = !!plannedName;
        
        let currentIndex = 0;
        // åŠ¨ç”»å‚æ•°ï¼šæ ¹æ®å¥–é¡¹æ•°é‡åŠ¨æ€è®¡ç®—ï¼Œç¡®ä¿èƒ½è·‘åˆ°æœ€åä¸€é¡¹ï¼ˆä¾‹å¦‚ 0.01 å…ƒä¸ä¼šè¢«è·³è¿‡ï¼‰
        const animationStepMs = 80; // æ¯æ­¥é—´éš”ï¼ˆè¶Šå°è¶Šå¿«ï¼‰
        const animationDurationMs = Math.max(
          520,
          prizeItems.length * animationStepMs + 80 // è‡³å°‘å®Œæ•´èµ°ä¸€åœˆ + å°‘é‡ç¼“å†²
        );
        let animationInterval = null;
        let animationTimeout = null;
        
        // ç»Ÿä¸€çš„å®ŒæˆæŠ½å¥–å‡½æ•°ï¼ˆå®šä¹‰åœ¨ä½¿ç”¨ä¹‹å‰ï¼‰
        async function finishDrawWithPrize(prizeName) {
          try {
            const prize = { name: prizeName };

            // é«˜äº®æ˜¾ç¤ºä¸­å¥–é¡¹
            prizeItems.forEach((item) => {
              item.classList.remove('highlight');
              if (item.textContent === prize.name) {
                item.classList.add('highlight');
              }
            });

            // ä¿å­˜è®°å½•åˆ° LeanCloud
            let saveSuccess = false;
            try {
              saveSuccess = await saveDrawRecord(prize.name);
            } catch (error) {
              console.error('ä¿å­˜è®°å½•æ—¶å‡ºé”™:', error);
              saveSuccess = false;
            }

            // æ‰£å‡ LeanCloud ä¸­ä»Šæ—¥å‰©ä½™æ¬¡æ•°
            const today = getTodayString();
            let record = await getDrawCountRecord(currentUsername, today);
            if (!record) record = await createDrawCountRecord(currentUsername, today, MAX_DAILY_DRAWS);
            if (record) {
              const nowRemaining = Math.max(0, (record.get('remainingCount') || 0) - 1);
              record.set('remainingCount', nowRemaining);
              await record.save();
              todayDrawCount = MAX_DAILY_DRAWS - nowRemaining;
            } else {
              todayDrawCount++;
            }

            const remaining = MAX_DAILY_DRAWS - todayDrawCount;
            const remainingCountEl = document.getElementById('remainingCount');
            const drawInfoEl = document.getElementById('drawInfo');

            if (remainingCountEl) remainingCountEl.textContent = remaining;
            if (drawInfoEl) drawInfoEl.textContent = `ä»Šæ—¥å‰©ä½™æŠ½å¥–æ¬¡æ•°: ${remaining} æ¬¡`;
            if (drawButton) {
              drawButton.disabled = remaining <= 0;
              drawButton.textContent = 'æŠ½å¥–';
            }

            // é‡æ–°åŠ è½½è®°å½•ï¼ˆæ— è®ºä¿å­˜æ˜¯å¦æˆåŠŸéƒ½å°è¯•åŠ è½½ï¼‰
            try {
              await loadRecords('my');
            } catch (error) {
              console.error('åŠ è½½è®°å½•æ—¶å‡ºé”™:', error);
            }

            // æ˜¾ç¤ºä¸­å¥–æç¤º
            setTimeout(() => {
              if (!saveSuccess) {
                alert(`æŠ½ä¸­ï¼š${prize.name}ï¼Œä¿å­˜å¤±è´¥ï¼Œè¯·å°†æ­¤æç¤ºæˆªå±è”ç³»ç®¡ç†å‘˜å¹¶ç¨åé‡è¯•`);
              }
              prizeItems.forEach(item => item.classList.remove('highlight'));
            }, 500);
          } catch (error) {
            console.error('æŠ½å¥–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
            console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
            // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ¢å¤
            if (drawButton) {
              drawButton.disabled = false;
              drawButton.textContent = 'æŠ½å¥–';
            }
            const remainingCountEl = document.getElementById('remainingCount');
            const drawInfoEl = document.getElementById('drawInfo');
            const remaining = MAX_DAILY_DRAWS - todayDrawCount;

            if (remainingCountEl) {
              remainingCountEl.textContent = remaining;
            }
            if (drawInfoEl) {
              drawInfoEl.textContent = `ä»Šæ—¥å‰©ä½™æŠ½å¥–æ¬¡æ•°: ${remaining} æ¬¡`;
            }
            prizeItems.forEach(item => item.classList.remove('highlight'));
            alert('æŠ½å¥–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
          }
        }
        
        // åŠ¨ç”»å¾ªç¯å‡½æ•°
        const animateStep = () => {
          prizeItems.forEach(item => item.classList.remove('highlight'));
          prizeItems[currentIndex].classList.add('highlight');
          
          // å¦‚æœæœ‰é¢„è®¾å¥–é¡¹ï¼Œä¸”å½“å‰æ˜¾ç¤ºçš„æ˜¯æœ€åä¸€ä¸ªå¥–é¡¹ï¼ˆç´¢å¼•ä¸º prizeItems.length - 1ï¼‰ï¼Œåœæ­¢åŠ¨ç”»å¹¶è·³åˆ°é¢„è®¾å¥–é¡¹
          if (hasPlannedPrize && currentIndex === prizeItems.length - 1) {
            // å·²ç»è½¬åˆ°æœ€åä¸€ä¸ªå¥–é¡¹ï¼Œåœæ­¢åŠ¨ç”»
            clearInterval(animationInterval);
            clearTimeout(animationTimeout);
            animationInterval = null;
            
            // ç›´æ¥è·³åˆ°é¢„è®¾å¥–é¡¹
            finishDrawWithPrize(plannedName);
            return; // ä¸å†ç»§ç»­å¾ªç¯
          }
          
          currentIndex = (currentIndex + 1) % prizeItems.length;
        };
        
        animationInterval = setInterval(animateStep, animationStepMs);

        // åŠ¨ç”»ç»“æŸååœæ­¢å¹¶ç¡®å®šå¥–é¡¹ï¼ˆå¦‚æœæ²¡æœ‰é¢„è®¾å¥–é¡¹æˆ–åŠ¨ç”»æå‰ç»“æŸï¼‰
        animationTimeout = setTimeout(async () => {
          if (animationInterval) {
            clearInterval(animationInterval);
            animationInterval = null;
          }

          try {
            // å¦‚æœåŠ¨ç”»è‡ªç„¶ç»“æŸï¼Œä½¿ç”¨é¢„è®¾å¥–é¡¹ï¼ˆå¦‚æœä¹‹å‰æ²¡ç”¨åˆ°ï¼‰æˆ–æŒ‰æ¦‚ç‡è®¡ç®—
            const finalPlannedName = hasPlannedPrize ? plannedName : await getNextPrizeForUser();
            const prize = finalPlannedName ? { name: finalPlannedName } : calculatePrize();
            finishDrawWithPrize(prize.name);
          } catch (error) {
            console.error('æŠ½å¥–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
            // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ¢å¤
            if (drawButton) {
              drawButton.disabled = false;
              drawButton.textContent = 'æŠ½å¥–';
            }
          }
        }, animationDurationMs);
      }
    }

    // æ ¹æ®æ¦‚ç‡è®¡ç®—å¥–é¡¹
    function calculatePrize() {
      const random = Math.random();
      let cumulativeProbability = 0;

      for (const prize of PRIZES) {
        cumulativeProbability += prize.probability;
        if (random <= cumulativeProbability) {
          return prize;
        }
      }

      // å¦‚æœæ‰€æœ‰æ¦‚ç‡éƒ½æ²¡åŒ¹é…åˆ°ï¼Œè¿”å›æœ€åä¸€ä¸ªï¼ˆè°¢è°¢å‚ä¸ï¼‰
      return PRIZES[PRIZES.length - 1];
    }

    // ä¿å­˜æŠ½å¥–è®°å½•
    async function saveDrawRecord(prizeName) {
      if (isDeveloperMode) {
        // å¼€å‘è€…æ¨¡å¼ï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        try {
          const record = {
            username: currentUsername,
            prize: prizeName,
            drawDate: getTodayString(),
            drawTime: new Date().toISOString(),
            isDeveloper: true
          };

          // è·å–ç°æœ‰çš„æœ¬åœ°è®°å½•
          const localRecords = JSON.parse(localStorage.getItem('developerRecords') || '[]');
          localRecords.push(record);

          // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆæœ€å¤šä¿ç•™1000æ¡è®°å½•ï¼‰
          if (localRecords.length > 1000) {
            localRecords.shift();
          }
          localStorage.setItem('developerRecords', JSON.stringify(localRecords));

          console.log('å¼€å‘è€…è®°å½•ä¿å­˜åˆ°æœ¬åœ°æˆåŠŸ');
          return true;
        } catch (error) {
          console.error('ä¿å­˜æœ¬åœ°è®°å½•å¤±è´¥:', error);
          return false;
        }
      } else {
        // ç”¨æˆ·æ¨¡å¼ï¼šä¿å­˜åˆ° LeanCloud
        try {
          const DrawRecord = AV.Object.extend('DrawRecord');
          const record = new DrawRecord();

          record.set('username', currentUsername);
          record.set('prize', prizeName);
          record.set('drawDate', getTodayString());
          record.set('drawTime', new Date());
          record.set('isDeveloper', false);

          await record.save();
          console.log('è®°å½•ä¿å­˜æˆåŠŸ');
          return true;
        } catch (error) {
          console.error('ä¿å­˜è®°å½•å¤±è´¥:', error);

          // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
          let errorMsg = 'ä¿å­˜è®°å½•å¤±è´¥ï¼š';
          if (error.code === 1) {
            errorMsg += 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
          } else if (error.code === 403) {
            errorMsg += 'æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥LeanCloudæ•°æ®è¡¨æƒé™è®¾ç½®';
          } else if (error.code === 400) {
            errorMsg += 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥é…ç½®';
          } else if (error.message) {
            errorMsg += error.message;
          } else {
            errorMsg += 'æœªçŸ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°';
          }

          alert(errorMsg);
          return false;
        }
      }
    }

    // åˆ‡æ¢é€‰é¡¹å¡
    function switchTab(tab) {
      // æ›´æ–°é€‰é¡¹å¡æ ·å¼
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // æ˜¾ç¤ºå¯¹åº”çš„è®°å½•åˆ—è¡¨
      const recordsPanel = document.getElementById('recordsPanel');
      const messagePanel = document.getElementById('messagePanel');

      if (tab === 'msg') {
        if (recordsPanel) recordsPanel.classList.add('hidden');
        if (messagePanel) messagePanel.classList.remove('hidden');
        loadMessages();
        startMessageCooldownCountdown();
        return;
      }

      if (messagePanel) messagePanel.classList.add('hidden');
      if (recordsPanel) recordsPanel.classList.remove('hidden');

      if (tab === 'my') {
        document.getElementById('myRecords').classList.remove('hidden');
        document.getElementById('allRecords').classList.add('hidden');
        loadRecords('my');
      } else {
        document.getElementById('myRecords').classList.add('hidden');
        document.getElementById('allRecords').classList.remove('hidden');
        loadRecords('all');
      }
    }

    // ==============
    // ç•™è¨€ï¼ˆæ‰€æœ‰äººå¯è§ï¼‰
    // ==============
    async function loadMessages() {
      const list = document.getElementById('messageList');
      if (!list) return;
      list.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const Message = AV.Object.extend('Message');
        const query = new AV.Query(Message);
        query.descending('createdAt');
        query.limit(100);
        const results = await query.find();

        if (!results || results.length === 0) {
          list.innerHTML = '<div class="empty-records">æš‚æ— ç•™è¨€</div>';
          return;
        }

        list.innerHTML = '';
        results.forEach((m) => {
          const username = m.get('username') || '';
          const content = m.get('content') || '';
          const timeStr = formatDateTime(new Date(m.createdAt));
          const id = m.id;
          const isAdmin = currentUsername === 'å°ç¨³ç¥';

          const card = document.createElement('div');
          card.className = 'message-card';
          card.innerHTML = `
            ${isAdmin ? `
              <div class="message-actions">
                <button class="message-action-btn" onclick="openMessageEdit('${id}')">ç¼–è¾‘</button>
                <button class="message-action-btn danger" onclick="deleteMessage('${id}')">åˆ é™¤</button>
              </div>
            ` : ''}
            <div class="message-meta">
              <span class="message-user">${escapeHtml(username)}</span>
              <span class="message-time">${timeStr}</span>
            </div>
            <div class="message-text">${escapeHtml(content)}</div>
          `;
          list.appendChild(card);
        });
      } catch (error) {
        console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error);
        list.innerHTML = '<div class="empty-records">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
      }
    }

    // ç•™è¨€å‘é€é¢‘ç‡æ§åˆ¶ï¼ˆæ¯ä¸ªç”¨æˆ· 120 ç§’ä¸€æ¬¡ï¼‰
    const MESSAGE_COOLDOWN_SECONDS = 120;
    let messageCooldownTimer = null;

    function getMessageCooldownKey() {
      return `message_last_sent_at_v1::${currentUsername || ''}`;
    }

    function getRemainingMessageCooldownSeconds() {
      if (!currentUsername) return 0;
      const key = getMessageCooldownKey();
      const last = Number(localStorage.getItem(key) || '0');
      if (!last) return 0;
      const elapsedMs = Date.now() - last;
      const remainingMs = MESSAGE_COOLDOWN_SECONDS * 1000 - elapsedMs;
      return Math.max(0, Math.ceil(remainingMs / 1000));
    }

    function updateMessageSendButtonState() {
      const btn = document.getElementById('messageSendBtn');
      if (!btn) return;
      const remaining = getRemainingMessageCooldownSeconds();
      if (remaining > 0) {
        btn.disabled = true;
        btn.textContent = `${remaining}s åå¯å‘é€`;
      } else {
        btn.disabled = false;
        btn.textContent = 'å‘é€';
      }
    }

    function startMessageCooldownCountdown() {
      if (messageCooldownTimer) {
        clearInterval(messageCooldownTimer);
        messageCooldownTimer = null;
      }
      updateMessageSendButtonState();
      messageCooldownTimer = setInterval(() => {
        const remaining = getRemainingMessageCooldownSeconds();
        updateMessageSendButtonState();
        if (remaining <= 0) {
          clearInterval(messageCooldownTimer);
          messageCooldownTimer = null;
        }
      }, 500);
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const btn = document.getElementById('messageSendBtn');
      if (!input || !btn) return;

      // å†·å´ä¸­ä¸å…è®¸å‘é€
      const remaining = getRemainingMessageCooldownSeconds();
      if (remaining > 0) {
        startMessageCooldownCountdown();
        return;
      }

      const content = (input.value || '').trim();
      if (!content) return;

      btn.disabled = true;
      btn.textContent = 'å‘é€ä¸­...';

      try {
        const Message = AV.Object.extend('Message');
        const msg = new Message();
        msg.set('username', currentUsername);
        msg.set('content', content);
        await msg.save();

        input.value = '';
        await loadMessages();

        // è®°å½•æœ¬æ¬¡å‘é€æ—¶é—´å¹¶å¼€å§‹å€’è®¡æ—¶
        localStorage.setItem(getMessageCooldownKey(), String(Date.now()));
        startMessageCooldownCountdown();
      } catch (error) {
        console.error('å‘é€ç•™è¨€å¤±è´¥:', error);
        alert('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™è®¾ç½®');
      } finally {
        // å¦‚æœè¿›å…¥å†·å´åˆ™ä¿æŒç¦ç”¨å¹¶æ˜¾ç¤ºå€’è®¡æ—¶ï¼Œå¦åˆ™æ¢å¤å‘é€
        updateMessageSendButtonState();
      }
    }

    function openMessageEdit(id) {
      if (currentUsername !== 'å°ç¨³ç¥') return;
      const modal = document.getElementById('messageEditModal');
      const idEl = document.getElementById('messageEditId');
      const textEl = document.getElementById('messageEditText');
      if (!modal || !idEl || !textEl) return;

      // ä»å½“å‰åˆ—è¡¨ä¸­å–å‡ºåŸæ–‡ï¼ˆé¿å…é¢å¤–è¯·æ±‚ï¼‰
      const card = Array.from(document.querySelectorAll('.message-card')).find(c => c.querySelector('.message-actions button')?.getAttribute('onclick')?.includes(id));
      let currentText = '';
      if (card) {
        const textNode = card.querySelector('.message-text');
        currentText = textNode ? textNode.textContent : '';
      }

      idEl.value = id;
      textEl.value = currentText;
      modal.classList.add('show');
      setTimeout(() => textEl.focus(), 0);
    }

    function closeMessageEditModal() {
      const modal = document.getElementById('messageEditModal');
      const idEl = document.getElementById('messageEditId');
      const textEl = document.getElementById('messageEditText');
      if (modal) modal.classList.remove('show');
      if (idEl) idEl.value = '';
      if (textEl) textEl.value = '';
    }

    async function saveMessageEdit() {
      if (currentUsername !== 'å°ç¨³ç¥') return;
      const idEl = document.getElementById('messageEditId');
      const textEl = document.getElementById('messageEditText');
      if (!idEl || !textEl) return;
      const id = (idEl.value || '').trim();
      const newContent = (textEl.value || '').trim();
      if (!id) return;
      if (!newContent) {
        alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
        return;
      }

      try {
        const Message = AV.Object.extend('Message');
        const msg = AV.Object.createWithoutData('Message', id);
        msg.set('content', newContent); // åªæ›´æ–°å†…å®¹ï¼Œå…¶ä»–å­—æ®µä¸å˜
        await msg.save();
        closeMessageEditModal();
        await loadMessages();
      } catch (error) {
        console.error('ç¼–è¾‘ç•™è¨€å¤±è´¥:', error);
        alert('ç¼–è¾‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™è®¾ç½®');
      }
    }

    async function deleteMessage(id) {
      if (currentUsername !== 'å°ç¨³ç¥') return;
      if (!id) return;
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) return;

      try {
        const msg = AV.Object.createWithoutData('Message', id);
        await msg.destroy();
        await loadMessages();
      } catch (error) {
        console.error('åˆ é™¤ç•™è¨€å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™è®¾ç½®');
      }
    }

    // ç®€å•è½¬ä¹‰ï¼Œé¿å…ç•™è¨€æ’å…¥ HTML
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('\"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // åŠ è½½è®°å½•
    async function loadRecords(type) {
      const container = type === 'my' ? document.getElementById('myRecords') : document.getElementById('allRecords');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        let allRecords = [];

        if (type === 'my') {
          // æˆ‘çš„è®°å½•ï¼šæ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„æ‰€æœ‰è®°å½•
          // 1. åŠ è½½LeanCloudä¸­çš„ç”¨æˆ·è®°å½•
          try {
            const DrawRecord = AV.Object.extend('DrawRecord');
            const query = new AV.Query(DrawRecord);
            query.equalTo('username', currentUsername);
            query.notEqualTo('isDeveloper', true); // ä¸åŠ è½½æ—§çš„å¼€å‘è€…è®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰
            query.descending('drawTime');
            query.limit(100);
            const cloudResults = await query.find();

            cloudResults.forEach(result => {
              allRecords.push({
                prize: result.get('prize'),
                drawTime: result.get('drawTime'),
                username: result.get('username'),
                isDeveloper: false
              });
            });
          } catch (error) {
            console.error('åŠ è½½LeanCloudè®°å½•å¤±è´¥:', error);
          }

          // 2. åªæœ‰åœ¨å¼€å‘è€…æ¨¡å¼ä¸‹æ‰åŠ è½½æœ¬åœ°å­˜å‚¨çš„å¼€å‘è€…è®°å½•
          if (isDeveloperMode) {
            const localRecords = JSON.parse(localStorage.getItem('developerRecords') || '[]');
            localRecords.forEach(record => {
              if (record.username === currentUsername) {
                allRecords.push({
                  prize: record.prize,
                  drawTime: new Date(record.drawTime),
                  username: record.username,
                  isDeveloper: true
                });
              }
            });
          }
        } else {
          // ä»–äººè®°å½•ï¼šåªæ˜¾ç¤ºLeanCloudä¸­çš„éå¼€å‘è€…è®°å½•
          const DrawRecord = AV.Object.extend('DrawRecord');
          const query = new AV.Query(DrawRecord);
          query.notEqualTo('isDeveloper', true);
          query.descending('drawTime');
          query.limit(100);
          const results = await query.find();

          results.forEach(result => {
            allRecords.push({
              prize: result.get('prize'),
              drawTime: result.get('drawTime'),
              username: result.get('username'),
              isDeveloper: false
            });
          });
        }

        // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        allRecords.sort((a, b) => {
          const timeA = a.drawTime instanceof Date ? a.drawTime : new Date(a.drawTime);
          const timeB = b.drawTime instanceof Date ? b.drawTime : new Date(b.drawTime);
          return timeB - timeA;
        });

        // é™åˆ¶æ˜¾ç¤ºæ•°é‡
        allRecords = allRecords.slice(0, 100);

        if (allRecords.length === 0) {
          container.innerHTML = '<div class="empty-records">æš‚æ— è®°å½•</div>';
          return;
        }

        container.innerHTML = '';
        allRecords.forEach(record => {
          const recordItem = document.createElement('div');
          recordItem.className = 'record-item';

          const prize = record.prize;
          const drawTime = record.drawTime instanceof Date ? record.drawTime : new Date(record.drawTime);
          const username = record.username;
          const isDev = record.isDeveloper || false;

          // å½“å¤© vs å†å²ï¼šå†³å®šé¢œè‰²ï¼ˆæˆ‘çš„è®°å½•/ä»–äººè®°å½•éƒ½ä¸€è‡´ï¼‰
          const isToday = getDateStringFromDate(drawTime) === getTodayString();
          recordItem.classList.add(isToday ? 'is-today' : 'is-old');

          const timeStr = formatDateTime(drawTime);

          let html = `<div class="record-header">`;

          // ä»–äººè®°å½•ï¼šç”¨æˆ·ååœ¨æœ€å‰é¢
          if (type === 'all') {
            html += `<div class="username">${username}</div>`;
          }

          html += `<div class="time">${timeStr}</div>`;
          html += `<div class="prize">${prize}`;
          if (isDev && type === 'my') {
            html += ' <span style="color: #999; font-size: 12px;">(å¼€å‘è€…-æœ¬åœ°)</span>';
          }
          html += `</div>`;
          html += `</div>`;

          recordItem.innerHTML = html;
          container.appendChild(recordItem);
        });
      } catch (error) {
        console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
        let errorMsg = 'åŠ è½½å¤±è´¥ï¼š';
        if (error.code === 1) {
          errorMsg += 'ç½‘ç»œè¿æ¥å¤±è´¥';
        } else if (error.code === 403) {
          errorMsg += 'æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥æ•°æ®è¡¨æƒé™';
        } else if (error.message) {
          errorMsg += error.message;
        } else {
          errorMsg += 'æœªçŸ¥é”™è¯¯';
        }
        container.innerHTML = `<div class="empty-records">${errorMsg}<br>è¯·åˆ·æ–°é‡è¯•</div>`;
      }
    }

    // åˆ‡æ¢ä¸‹æ‹‰èœå•
    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownMenu');
      dropdown.classList.toggle('show');
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click', function (event) {
      const userInfo = document.querySelector('.user-info');
      const dropdown = document.getElementById('dropdownMenu');
      if (userInfo && dropdown && !userInfo.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });

    // æ‰“å¼€å¼€å‘è€…æ¨¡å¼å¯†ç è¾“å…¥
    function openDeveloperMode() {
      document.getElementById('dropdownMenu').classList.remove('show');
      document.getElementById('passwordModal').classList.add('show');
      document.getElementById('passwordInput').focus();
    }

    // å…³é—­å¯†ç è¾“å…¥å¼¹çª—
    function closePasswordModal() {
      document.getElementById('passwordModal').classList.remove('show');
      document.getElementById('passwordInput').value = '';
    }

    // æ˜¾ç¤ºæ¦‚ç‡å¼¹çª—
    function showProbabilityModal() {
      const modal = document.getElementById('probabilityModal');
      const list = document.getElementById('probabilityList');

      // æ¸…ç©ºåˆ—è¡¨
      list.innerHTML = '';

      // éå†å¥–å“å¹¶æ˜¾ç¤ºæ¦‚ç‡
      PRIZES.forEach(prize => {
        const item = document.createElement('div');
        item.className = 'probability-item';

        // ä½¿ç”¨ displayProbability å­—æ®µæ˜¾ç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨å®é™…æ¦‚ç‡
        const displayText = prize.displayProbability || ((prize.probability * 100).toFixed(8) + '%');

        item.innerHTML = `
          <span class="prize-name">${prize.name}</span>
          <span class="prize-probability">${displayText}</span>
        `;

        list.appendChild(item);
      });

      modal.classList.add('show');
    }

    // å…³é—­æ¦‚ç‡å¼¹çª—
    function closeProbabilityModal() {
      document.getElementById('probabilityModal').classList.remove('show');
    }

    // éªŒè¯å¯†ç å¹¶è¿›å…¥å¼€å‘è€…æ¨¡å¼
    function checkPassword() {
      const password = document.getElementById('passwordInput').value.trim();
      if (password === DEVELOPER_PASSWORD) {
        isDeveloperMode = true;
        localStorage.setItem('isDeveloperMode', 'true');
        closePasswordModal();
        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æ‰€æœ‰çŠ¶æ€
        location.reload();
      } else {
        alert('å¯†ç é”™è¯¯ï¼');
        document.getElementById('passwordInput').value = '';
      }
    }

    // é€€å‡ºå¼€å‘è€…æ¨¡å¼
    function exitDeveloperMode() {
      isDeveloperMode = false;
      localStorage.removeItem('isDeveloperMode');
      document.getElementById('dropdownMenu').classList.remove('show');
      location.reload();
    }

    // ============== ç®¡ç†å‘˜åå° ==============
    function openAdminPanel() {
      document.getElementById('dropdownMenu').classList.remove('show');
      document.getElementById('adminPasswordModal').classList.add('show');
      document.getElementById('adminPasswordInput').value = '';
      document.getElementById('adminPasswordInput').focus();
    }

    function closeAdminPasswordModal() {
      document.getElementById('adminPasswordModal').classList.remove('show');
      document.getElementById('adminPasswordInput').value = '';
    }

    function checkAdminPassword() {
      const pwd = document.getElementById('adminPasswordInput').value.trim();
      if (pwd === ADMIN_PASSWORD) {
        isAdminMode = true;
        closeAdminPasswordModal();
        document.getElementById('mainSection').classList.add('hidden');
        document.getElementById('adminSection').classList.remove('hidden');
        adminInitTabs();
        adminLoadPrizesForm();
      } else {
        alert('ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼');
        document.getElementById('adminPasswordInput').value = '';
      }
    }

    function exitAdminPanel() {
      isAdminMode = false;
      document.getElementById('adminSection').classList.add('hidden');
      document.getElementById('mainSection').classList.remove('hidden');
    }

    function adminInitTabs() {
      document.querySelectorAll('.admin-tab').forEach((tab) => {
        tab.onclick = function () {
          const t = this.getAttribute('data-tab');
          document.querySelectorAll('.admin-tab').forEach((x) => x.classList.remove('active'));
          document.querySelectorAll('.admin-tab-panel').forEach((x) => x.classList.remove('active'));
          this.classList.add('active');
          const panel = document.getElementById('adminTab' + t.charAt(0).toUpperCase() + t.slice(1));
          if (panel) panel.classList.add('active');
          if (t === 'prizes') adminLoadPrizesForm();
          if (t === 'preset') {
            adminInitPresetPrizeOptions();
            adminLoadPresetList();
          }
        };
      });
    }

    async function adminSaveQuota() {
      const username = document.getElementById('adminQuotaUsername').value.trim();
      const remaining = document.getElementById('adminQuotaRemaining').value.trim();
      if (!username) {
        alert('è¯·è¾“å…¥ç”¨æˆ·å');
        return;
      }
      const n = parseInt(remaining, 10);
      if (isNaN(n) || n < 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å‰©ä½™æ¬¡æ•°ï¼ˆâ‰¥0ï¼‰');
        return;
      }
      const today = getTodayString();
      const ok = await setDrawQuotaOverride(username, today, n);
      if (ok) alert('å·²ä¿å­˜ï¼š' + username + ' ä»Šæ—¥å‰©ä½™æŠ½å¥–æ¬¡æ•° ' + n + ' æ¬¡');
      else alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
    }

    async function adminLoadWinnings() {
      const listEl = document.getElementById('adminWinningsList');
      listEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      try {
        const DrawRecord = AV.Object.extend('DrawRecord');
        const query = new AV.Query(DrawRecord);
        query.notEqualTo('isDeveloper', true);
        query.limit(1000);
        const results = await query.find();
        const today = getTodayString();
        const byUser = {};
        results.forEach((r) => {
          const u = r.get('username') || '';
          const prize = r.get('prize') || '';
          const dateStr = r.get('drawDate') || getDateStringFromDate(r.get('drawTime'));
          const yuan = parsePrizeToYuan(prize);
          if (!byUser[u]) {
            byUser[u] = { today: 0, total: 0 };
          }
          byUser[u].total += yuan;
          if (dateStr === today) byUser[u].today += yuan;
        });
        const rows = Object.keys(byUser)
          .sort((a, b) => byUser[b].total - byUser[a].total)
          .map((u) => `<tr><td>${escapeHtml(u)}</td><td>${byUser[u].today.toFixed(2)} å…ƒ</td><td>${byUser[u].total.toFixed(2)} å…ƒ</td></tr>`)
          .join('');
        listEl.innerHTML = '<table class="admin-table"><thead><tr><th>ç”¨æˆ·</th><th>ä»Šæ—¥ä¸­å¥–</th><th>å†å²æ€»ä¸­å¥–</th></tr></thead><tbody>' + rows + '</tbody></table>';
      } catch (e) {
        listEl.innerHTML = '<div class="empty-records">åŠ è½½å¤±è´¥ï¼š' + (e.message || e) + '</div>';
      }
    }

    function adminLoadPrizesForm() {
      const container = document.getElementById('adminPrizesList');
      if (!container) return;
      container.innerHTML = '';
      PRIZES.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'admin-prize-row';
        div.innerHTML = `
          <input type="text" class="prize-name-inp" data-i="${i}" data-field="name" value="${escapeHtml(p.name)}" placeholder="å¥–é¡¹å" />
          <input type="number" class="prize-prob-inp" data-i="${i}" data-field="probability" step="0.0001" min="0" max="1" value="${p.probability}" placeholder="çœŸå®æ¦‚ç‡" />
          <input type="text" class="prize-display-inp" data-i="${i}" data-field="displayProbability" value="${escapeHtml(p.displayProbability || '')}" placeholder="å±•ç¤ºæ¦‚ç‡" />
        `;
        container.appendChild(div);
      });
    }

    async function adminSavePrizes() {
      const rows = document.querySelectorAll('#adminPrizesList .admin-prize-row');
      const next = [];
      for (let i = 0; i < rows.length; i++) {
        const name = rows[i].querySelector('.prize-name-inp')?.value?.trim() || 'å¥–é¡¹' + (i + 1);
        const probInp = rows[i].querySelector('.prize-prob-inp');
        const displayInp = rows[i].querySelector('.prize-display-inp');
        const prob = parseFloat(probInp?.value) || 0;
        const display = displayInp?.value?.trim() || (prob * 100).toFixed(2) + '%';
        next.push({ name, probability: prob, displayProbability: display });
      }
      if (next.length === 0) {
        alert('è¯·è‡³å°‘ä¿ç•™ä¸€é¡¹');
        return;
      }
      PRIZES = next;
      renderPrizesGrid();
      const ok = await setAppConfig('prizes', JSON.stringify(next));
      if (ok) alert('å¥–é¡¹é…ç½®å·²ä¿å­˜');
      else alert('ä¿å­˜å¤±è´¥');
    }

    // é¢„è®¾å¥–é¡¹ï¼ˆUserPrizePlanï¼‰
    function adminInitPresetPrizeOptions() {
      const selects = document.querySelectorAll('.preset-prize-select');
      if (!selects.length) return;
      selects.forEach((sel) => {
        const current = sel.value;
        sel.innerHTML = '';
        const emptyOpt = document.createElement('option');
        emptyOpt.value = '';
        emptyOpt.textContent = 'ï¼ˆä¸è®¾ç½®ï¼‰';
        sel.appendChild(emptyOpt);
        PRIZES.forEach((p) => {
          const opt = document.createElement('option');
          opt.value = p.name;
          opt.textContent = p.name;
          sel.appendChild(opt);
        });
        // ä¿æŒåŸå…ˆé€‰æ‹©
        if (current) sel.value = current;
      });
    }

    async function adminSavePresetPrizes() {
      const username = document.getElementById('adminPresetUsername').value.trim();
      if (!username) {
        alert('è¯·è¾“å…¥ç”¨æˆ·å');
        return;
      }
      const selects = document.querySelectorAll('.preset-prize-select');
      const prizes = [];
      selects.forEach((sel) => {
        const v = sel.value;
        if (v) prizes.push(v);
      });
      if (!prizes.length) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¢„è®¾å¥–é¡¹');
        return;
      }
      try {
        const Plan = AV.Object.extend('UserPrizePlan');
        let obj = null;
        let shouldCreateNew = true;
        
        // å°è¯•æŸ¥è¯¢ç°æœ‰è®°å½•ï¼ˆå¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œquery.first() å¯èƒ½è¿”å› null æˆ–æŠ›å‡ºé”™è¯¯ï¼‰
        try {
          const query = new AV.Query(Plan);
          query.equalTo('username', username);
          obj = await query.first();
          if (obj) {
            // æ‰¾åˆ°äº†ç°æœ‰è®°å½•ï¼Œæ›´æ–°å®ƒ
            shouldCreateNew = false;
          }
        } catch (queryErr) {
          // æŸ¥è¯¢å‡ºé”™ï¼ˆå¯èƒ½æ˜¯è¡¨ä¸å­˜åœ¨æˆ–å…¶ä»–é”™è¯¯ï¼‰ï¼Œç›´æ¥åˆ›å»ºæ–°å¯¹è±¡
          console.log('æŸ¥è¯¢é¢„è®¾å¥–é¡¹æ—¶å‡ºé”™ï¼Œå°†åˆ›å»ºæ–°è®°å½•:', queryErr);
          shouldCreateNew = true;
        }
        
        // åˆ›å»ºæ–°å¯¹è±¡æˆ–ä½¿ç”¨ç°æœ‰å¯¹è±¡
        if (shouldCreateNew || !obj) {
          obj = new Plan();
          obj.set('username', username);
        }
        
        // è®¾ç½®å¥–é¡¹æ•°æ®
        obj.set('prizesJson', JSON.stringify(prizes));
        
        // ä¿å­˜ï¼ˆLeanCloud ä¼šåœ¨é¦–æ¬¡ä¿å­˜æ—¶è‡ªåŠ¨åˆ›å»ºè¡¨ï¼Œå‰ææ˜¯æƒé™å…è®¸ï¼‰
        await obj.save();
        alert('é¢„è®¾å¥–é¡¹å·²ä¿å­˜');
        adminLoadPresetList();
      } catch (e) {
        console.error('adminSavePresetPrizes error:', e);
        let errorMsg = 'ä¿å­˜å¤±è´¥ï¼š' + (e.message || e);
        if (e.code === 403) {
          errorMsg += '\n\næç¤ºï¼šè¯·æ£€æŸ¥ LeanCloud æ§åˆ¶å°ä¸­ UserPrizePlan è¡¨çš„æƒé™è®¾ç½®ï¼Œç¡®ä¿å…è®¸åˆ›å»ºå’Œæ›´æ–°æ•°æ®ã€‚';
        } else if (e.code === 404) {
          errorMsg += '\n\næç¤ºï¼šè¡¨ä¸å­˜åœ¨ã€‚è¯·å…ˆåœ¨ LeanCloud æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»º UserPrizePlan è¡¨ï¼Œæˆ–æ£€æŸ¥æƒé™è®¾ç½®æ˜¯å¦å…è®¸è‡ªåŠ¨åˆ›å»ºè¡¨ã€‚';
        }
        alert(errorMsg);
      }
    }

    async function adminLoadPresetList() {
      const wrap = document.getElementById('adminPresetList');
      if (!wrap) return;
      wrap.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      try {
        const Plan = AV.Object.extend('UserPrizePlan');
        const query = new AV.Query(Plan);
        query.limit(200);
        query.ascending('username');
        const results = await query.find();
        if (!results.length) {
          wrap.innerHTML = '<div class="empty-records">æš‚æ— é¢„è®¾å¥–é¡¹</div>';
          return;
        }
        const rows = results.map((r) => {
          const u = r.get('username') || '';
          const raw = r.get('prizesJson') || '[]';
          let arr;
          try {
            arr = JSON.parse(raw);
          } catch {
            arr = [];
          }
          const txt = Array.isArray(arr) ? arr.join('ï¼Œ') : '';
          return `<tr>
            <td>${escapeHtml(u)}</td>
            <td>${escapeHtml(txt)}</td>
            <td>
              <button type="button" class="admin-link-btn" onclick="adminEditPreset('${u}')">ä¿®æ”¹</button>
              <button type="button" class="admin-link-btn danger" onclick="adminDeletePreset('${u}')">åˆ é™¤</button>
            </td>
          </tr>`;
        }).join('');
        wrap.innerHTML = '<table class="admin-table"><thead><tr><th>ç”¨æˆ·</th><th>é¢„è®¾å¥–é¡¹ï¼ˆé¡ºåºï¼‰</th><th>æ“ä½œ</th></tr></thead><tbody>' + rows + '</tbody></table>';
      } catch (e) {
        // 404 è¡¨ç¤ºè¡¨ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºç©ºåˆ—è¡¨
        if (e.code === 404 || e.status === 404) {
          wrap.innerHTML = '<div class="empty-records">æš‚æ— é¢„è®¾å¥–é¡¹ï¼ˆè¡¨å°šæœªåˆ›å»ºï¼‰</div>';
        } else {
          console.error('adminLoadPresetList error:', e);
          wrap.innerHTML = '<div class="empty-records">åŠ è½½å¤±è´¥ï¼š' + (e.message || e) + '</div>';
        }
      }
    }

    async function adminDeletePreset(username) {
      if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç”¨æˆ·çš„é¢„è®¾å¥–é¡¹ï¼Ÿ')) return;
      try {
        const Plan = AV.Object.extend('UserPrizePlan');
        const query = new AV.Query(Plan);
        query.equalTo('username', username);
        const obj = await query.first();
        if (obj) await obj.destroy();
        adminLoadPresetList();
      } catch (e) {
        // 404 è¡¨ç¤ºè¡¨ä¸å­˜åœ¨æˆ–è®°å½•ä¸å­˜åœ¨ï¼Œè§†ä¸ºåˆ é™¤æˆåŠŸ
        if (e.code === 404 || e.status === 404) {
          adminLoadPresetList();
        } else {
          alert('åˆ é™¤å¤±è´¥ï¼š' + (e.message || e));
        }
      }
    }

    async function adminEditPreset(username) {
      // å°†è¯¥ç”¨æˆ·çš„é¢„è®¾å¥–é¡¹åŠ è½½åˆ°ä¸Šæ–¹è¡¨å•ä¸­ï¼Œä¾¿äºä¿®æ”¹
      try {
        const Plan = AV.Object.extend('UserPrizePlan');
        const query = new AV.Query(Plan);
        query.equalTo('username', username);
        const obj = await query.first();
        if (!obj) {
          alert('è¯¥ç”¨æˆ·æš‚æ— é¢„è®¾å¥–é¡¹');
          return;
        }
        const raw = obj.get('prizesJson') || '[]';
        let arr;
        try {
          arr = JSON.parse(raw);
        } catch {
          arr = [];
        }
        const usernameInput = document.getElementById('adminPresetUsername');
        if (usernameInput) usernameInput.value = username;
        adminInitPresetPrizeOptions();
        const selects = document.querySelectorAll('.preset-prize-select');
        selects.forEach((sel, idx) => {
          sel.value = arr[idx] || '';
        });
      } catch (e) {
        // 404 è¡¨ç¤ºè¡¨ä¸å­˜åœ¨æˆ–è®°å½•ä¸å­˜åœ¨
        if (e.code === 404 || e.status === 404) {
          alert('è¯¥ç”¨æˆ·æš‚æ— é¢„è®¾å¥–é¡¹');
        } else {
          console.error('adminEditPreset error:', e);
          alert('åŠ è½½å¤±è´¥ï¼š' + (e.message || e));
        }
      }
    }

    async function adminLoadRecords() {
      const listEl = document.getElementById('adminRecordsList');
      const username = document.getElementById('adminRecordsUsername').value.trim();
      listEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      try {
        const DrawRecord = AV.Object.extend('DrawRecord');
        const query = new AV.Query(DrawRecord);
        query.notEqualTo('isDeveloper', true);
        if (username) query.equalTo('username', username);
        query.descending('drawTime');
        query.limit(200);
        const results = await query.find();
        if (results.length === 0) {
          listEl.innerHTML = '<div class="empty-records">æš‚æ— è®°å½•</div>';
          return;
        }
        const rows = results.map((r) => {
          const id = r.id;
          const u = r.get('username') || '';
          const prize = r.get('prize') || '';
          const time = r.get('drawTime');
          const timeStr = time ? formatDateTime(time instanceof Date ? time : new Date(time)) : '';
          return `<tr data-id="${id}">
            <td>${escapeHtml(u)}</td><td>${timeStr}</td><td>${escapeHtml(prize)}</td>
            <td>
              <button type="button" class="admin-link-btn" onclick="adminEditRecord('${id}')">ä¿®æ”¹</button>
              <button type="button" class="admin-link-btn danger" onclick="adminDeleteRecord('${id}')">åˆ é™¤</button>
            </td>
          </tr>`;
        }).join('');
        listEl.innerHTML = '<table class="admin-table"><thead><tr><th>ç”¨æˆ·</th><th>æ—¶é—´</th><th>å¥–é¡¹</th><th>æ“ä½œ</th></tr></thead><tbody>' + rows + '</tbody></table>';
      } catch (e) {
        listEl.innerHTML = '<div class="empty-records">åŠ è½½å¤±è´¥ï¼š' + (e.message || e) + '</div>';
      }
    }

    async function adminDeleteRecord(objectId) {
      if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
      try {
        const DrawRecord = AV.Object.extend('DrawRecord');
        const obj = AV.Object.createWithoutData('DrawRecord', objectId);
        await obj.destroy();
        alert('å·²åˆ é™¤');
        adminLoadRecords();
      } catch (e) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + (e.message || e));
      }
    }

    async function adminEditRecord(objectId) {
      const newPrize = prompt('è¯·è¾“å…¥æ–°çš„å¥–é¡¹åç§°ï¼ˆå¦‚ï¼š10å…ƒã€è°¢è°¢å‚ä¸ï¼‰');
      if (newPrize == null || newPrize.trim() === '') return;
      try {
        const obj = AV.Object.createWithoutData('DrawRecord', objectId);
        obj.set('prize', newPrize.trim());
        await obj.save();
        alert('å·²ä¿®æ”¹');
        adminLoadRecords();
      } catch (e) {
        alert('ä¿®æ”¹å¤±è´¥ï¼š' + (e.message || e));
      }
    }

  </script>
</body>

</html>
