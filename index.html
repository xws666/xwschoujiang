<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>小稳神-抽奖模拟器</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: white;
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 60px;
      /* 为底部固定元素预留空间 */
      color: #333;
    }

    /* 满屏斜向水印层（内容为登录用户名） */
    #watermarkLayer {
      position: fixed;
      inset: 0;
      z-index: 900;
      /* 低于导航栏(1000)/底部(999)，高于内容 */
      pointer-events: none;
      background-repeat: repeat;
      background-position: 0 0;
      /* 平铺密度由 JS 配置动态设置 background-size */
      display: none;
      /* 未登录时不显示 */
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 0;
    }

    h1 {
      text-align: center;
      color: #000000;
      margin-bottom: 20px;
      font-size: 24px;
    }

    /* 用户名输入区域 */
    .username-section {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 400px;
      padding: 0;
    }

    .username-section input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      margin-bottom: 10px;
      background: white;
    }

    .username-section button {
      width: 100%;
      padding: 12px;
      background: #3b93ff;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .username-section button:hover {
      background: #5568d3;
    }

    .username-section button:active {
      transform: scale(0.98);
    }

    .username-section .tip {
      text-align: center;
      margin-top: 15px;
      color: #666666;
      font-size: 14px;
    }

    /* 奖品展示区域 */
    .prizes-section {
      margin-bottom: 20px;
    }

    .prizes-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .prize-item {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 4px;
      text-align: center;
      color: #333;
      font-weight: bold;
      border: 1px solid #e0e0e0;
    }

    .prize-item.highlight {
      background: #fff3cd;
      border-color: #ffc107;
      transform: scale(1.05);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1.05);
      }

      50% {
        transform: scale(1.1);
      }
    }

    /* 抽奖按钮区域 */
    .draw-section {
      position: relative;
      /* margin-bottom: 10px; */
    }

    .probability-link {
      padding: 5px;
      position: absolute;
      left: 0;
      top: -25px;
      font-size: 14px;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
    }

    .probability-link:hover {
      color: #5568d3;
    }

    /* 抽奖次数（按钮上方右侧） */
    .draw-info-top {
      padding: 5px;
      position: absolute;
      right: 0;
      top: -25px;
      font-size: 14px;
      color: #666;
      white-space: nowrap;
      user-select: none;
    }

    /* 抽奖按钮 */
    .draw-button {
      margin: 0px 0px 10px 0px;
      width: 100%;
      padding: 10px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }

    .draw-button:hover:not(:disabled) {
      background: #5568d3;
    }

    .draw-button:active:not(:disabled) {
      background: #4a5bc4;
    }

    .draw-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    .draw-info {
      text-align: center;
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }

    /* 记录选项卡 */
    .tabs {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: none;
      border: none;
      font-size: 16px;
      color: #666;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: bold;
    }

    /* 记录列表 */
    .records-section {
      max-height: 400px;
      overflow-y: auto;
    }

    /* 留言 */
    .message-panel {
      height: 400px;
      display: flex;
      flex-direction: column;
      border: 1px solid #eee;
      border-radius: 6px;
      background: #fff;
      overflow: hidden;
    }

    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px;
      background: #fafafa;
    }

    .message-card {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 5px 8px;
      /* margin-bottom: 10px; */
      margin-bottom: 10px;
      position: relative;
    }

    .message-meta {
      display: flex;
      gap: 8px;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .message-actions {
      position: absolute;
      top: 6px;
      right: 8px;
      display: flex;
      gap: 10px;
      font-size: 12px;
      align-items: center;
    }

    .message-action-btn {
      border: none;
      background: transparent;
      color: #667eea;
      cursor: pointer;
      padding: 2px 4px;
    }

    .message-action-btn.danger {
      color: #d33;
    }

    .message-user {
      font-weight: 800;
      color: #111;
      font-size: 14px;
      white-space: nowrap;
    }

    .message-time {
      font-size: 12px;
      color: #999;
      white-space: nowrap;
    }

    .message-text {
      font-size: 14px;
      color: #333;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* 留言风险提示滚动条 */
    .message-ticker {
      border-top: 1px solid #eee;
      background: #fff7e6;
      color: #8a5a00;
      font-size: 12px;
      line-height: 24px;
      height: 24px;
      overflow: hidden;
      white-space: nowrap;
      padding: 0 12px;
    }

    .message-ticker-track {
      display: inline-block;
      padding-left: 100%;
      animation: messageTickerScroll 18s linear infinite;
      will-change: transform;
    }

    .message-ticker:hover .message-ticker-track {
      animation-play-state: paused;
    }

    @keyframes messageTickerScroll {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-100%);
      }
    }

    .message-composer {
      display: flex;
      gap: 10px;
      padding: 10px 12px;
      border-top: 1px solid #eee;
      background: #fff;
    }

    .message-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }

    .message-send {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .message-send:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .record-item {
      padding: 8px 12px;
      margin-bottom: 10px;
      background: #f9f9f9;
      border-radius: 4px;
      border-left: 3px solid #bdbdbd;
      /* 默认：非当天灰色 */
    }

    .record-item.is-today {
      border-left-color: #667eea;
      /* 当天：蓝色 */
    }

    .record-item .record-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }

    .record-item .time {
      font-size: 14px;
      color: #999;
      white-space: nowrap;
    }

    .record-item .prize {
      font-size: 14px;
      font-weight: bold;
      color: #9e9e9e;
      /* 默认：非当天灰色 */
      flex: 1;
    }

    .record-item.is-today .prize {
      color: #667eea;
      /* 当天：蓝色 */
    }

    .record-item .username {
      font-size: 14px;
      color: #000;
      font-weight: bold;
      margin-right: 10px;
    }

    .empty-records {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    /* 加载提示 */
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    /* 底部版权信息 */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      text-align: center;
      padding: 5px 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
      z-index: 999;
    }

    .footer .copyright {
      font-size: 14px;
      color: #999;
    }

    /* 导航栏 */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }

    .navbar .title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      position: relative;
    }

    .navbar .username {
      font-size: 16px;
      color: #667eea;
    }

    .navbar .switch-btn {
      padding: 5px 10px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      color: #666;
      cursor: pointer;
    }

    .navbar .switch-btn:hover {
      background: #e0e0e0;
    }

    /* 顶部通知/公告滚动条（紧贴导航栏下方，固定在页面顶部） */
    .site-ticker {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      background: #eaf2ff;
      color: #1b4b8a;
      font-size: 13px;
      line-height: 28px;
      height: 28px;
      overflow: hidden;
      white-space: nowrap;
      padding: 0 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .site-ticker-track {
      display: inline-block;
      padding-left: 100%;
      animation: siteTickerScroll 16s linear infinite;
      will-change: transform;
    }

    .site-ticker:hover .site-ticker-track {
      animation-play-state: paused;
    }

    @keyframes siteTickerScroll {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-100%);
      }
    }

    /* 下拉弹窗 */
    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 10px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 200px;
      z-index: 1001;
      display: none;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-menu .menu-item {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 1px solid #f5f5f5;
      transition: background 0.2s;
    }

    .dropdown-menu .menu-item:last-child {
      border-bottom: none;
    }

    .dropdown-menu .menu-item:hover {
      background: #f5f5f5;
    }

    /* 密码输入弹窗 */
    .password-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .password-modal.show {
      display: flex;
    }

    .password-modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      /* height: 70%; */
    }

    .password-modal-content h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .password-modal-content input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      margin-bottom: 15px;
    }

    .password-modal-content .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .password-modal-content .modal-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }

    .password-modal-content .modal-buttons .confirm-btn {
      background: #667eea;
      color: white;
    }

    .password-modal-content .modal-buttons .cancel-btn {
      background: #f5f5f5;
      color: #666;
    }

    /* 公告弹窗 */
    .notice-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      padding: 16px;
    }

    .notice-modal.show {
      display: flex;
    }

    .notice-modal-content {
      background: #fff;
      width: 100%;
      max-width: 520px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
    }

    .notice-modal-header {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
    }

    .notice-title {
      font-size: 18px;
      font-weight: 700;
      color: #111;
    }

    .notice-modal-body {
      padding: 14px 16px;
      max-height: 60vh;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 14px;
      color: #333;
    }

    .notice-modal-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      border-top: 1px solid #eee;
      background: #fff;
    }

    .notice-skip {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #555;
      font-size: 14px;
      user-select: none;
    }

    .notice-confirm-btn {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .notice-confirm-btn:active {
      background: #5568d3;
    }

    /* 概率列表 */
    .probability-list {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .probability-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .probability-item:last-child {
      border-bottom: none;
    }

    .probability-item .prize-name {
      font-weight: bold;
      color: #333;
    }

    .probability-item .prize-probability {
      color: #667eea;
      font-weight: bold;
    }

    /* 隐藏类 */
    .hidden {
      display: none;
    }

    /* 管理员后台 */
    .admin-section {
      position: fixed;
      inset: 0;
      z-index: 1500;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .admin-section.hidden {
      display: none;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: #667eea;
      color: white;
      flex-shrink: 0;
    }

    .admin-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .admin-exit-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.25);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .admin-exit-btn:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    .admin-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 10px 16px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }

    .admin-tab {
      padding: 8px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
    }

    .admin-tab:hover {
      background: #f0f0f0;
    }

    .admin-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .admin-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .admin-tab-panel {
      display: none;
    }

    .admin-tab-panel.active {
      display: block;
    }

    .admin-hint {
      color: #666;
      font-size: 13px;
      margin-bottom: 12px;
    }

    .admin-form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
    }

    .admin-form-row input[type="text"],
    .admin-form-row input[type="number"] {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      min-width: 120px;
    }

    .admin-btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .admin-btn:hover {
      background: #5568d3;
    }

    .admin-btn.danger {
      background: #dc3545;
    }

    .admin-btn.danger:hover {
      background: #c82333;
    }

    /* 列表中的文字按钮样式 */
    .admin-link-btn {
      background: none;
      border: none;
      padding: 0;
      margin: 0 4px 0 0;
      font-size: 13px;
      cursor: pointer;
      color: #28a745;
      text-decoration: underline;
    }

    .admin-link-btn.danger {
      color: #dc3545;
    }

    .admin-link-btn:hover {
      opacity: 0.8;
    }

    .admin-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .admin-checkbox input {
      width: auto;
    }

    .admin-table-wrap {
      margin-top: 12px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .admin-table th,
    .admin-table td {
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      text-align: left;
    }

    .admin-table th {
      background: #f0f0f0;
    }

    .admin-prize-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 6px;
    }

    .admin-prize-row input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    .admin-prize-row .prize-name-inp {
      min-width: 80px;
    }

    .admin-prize-row .prize-prob-inp {
      width: 80px;
    }

    .admin-prize-row .prize-display-inp {
      min-width: 100px;
    }

    .preset-prize-select {
      min-width: 120px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <!-- 满屏水印（登录后显示，内容为用户名） -->
  <div id="watermarkLayer" aria-hidden="true"></div>

  <div class="container">
    <!-- 管理员弹窗公告（进入页面时若启用则弹出） -->
    <div id="adminAnnouncementModal" class="notice-modal">
      <div class="notice-modal-content" onclick="event.stopPropagation()">
        <div class="notice-modal-header">
          <div class="notice-title">公告</div>
        </div>
        <div id="adminAnnouncementContent" class="notice-modal-body"></div>
        <div class="notice-modal-footer">
          <button type="button" class="notice-confirm-btn" onclick="closeAdminAnnouncement()">知道了</button>
        </div>
      </div>
    </div>

    <!-- 公告弹窗（每日首次进入弹出，可勾选当日不再弹出） -->
    <div id="noticeModal" class="notice-modal">
      <div class="notice-modal-content" role="dialog" aria-modal="true" aria-labelledby="noticeTitle">
        <div class="notice-modal-header">
          <div id="noticeTitle" class="notice-title">公告</div>
        </div>
        <div id="noticeContent" class="notice-modal-body"></div>
        <div class="notice-modal-footer">
          <label class="notice-skip">
            <input id="noticeSkipToday" type="checkbox" />
            今日不再弹出
          </label>
          <button class="notice-confirm-btn" onclick="agreeNotice()">同意并继续</button>
        </div>
      </div>
    </div>

    <!-- 用户名输入区域 -->
    <div id="usernameSection" class="username-section">
      <h1>请设置一个用户名</h1>
      <input type="text" id="usernameInput" placeholder="请输入您的用户名（长度1~6个汉字/字符）" maxlength="6"
        oninput="limitUsernameLength()">
      <button onclick="saveUsername()">登录</button>
      <div class="tip">注意：登陆后无法退出，且无法修改用户名。</div>
    </div>

    <!-- 主抽奖区域 -->
    <div id="mainSection" class="hidden">
      <!-- 导航栏 -->
      <div class="navbar">
        <div class="title">小稳神抽奖</div>
        <div class="user-info" onclick="toggleDropdown()">
          <span class="username" id="displayUsername"></span>
          <span class="switch-btn">切换</span>
        </div>
        <!-- 下拉菜单 -->
        <div id="dropdownMenu" class="dropdown-menu">
          <div id="developerMenuItem" class="menu-item" onclick="openDeveloperMode()">开发者人员模式</div>
          <div class="menu-item" onclick="openAdminPanel()">管理员后台</div>
          <div id="exitDeveloperMenuItem" class="menu-item hidden" onclick="exitDeveloperMode()">返回用户</div>
        </div>
      </div>

      <!-- 顶部公告滚动条（可后续改为通知/公告） -->
      <div class="site-ticker" title="提示：鼠标悬停可暂停滚动" role="status" aria-live="polite">
        <div class="site-ticker-track" id="siteTickerText">恭喜“王家斌w”成为本站第一位“五连全中”的用户！恭喜“小钱特温柔”成为本站第一位得到“10元”奖项的用户！</div>
      </div>

      <!-- 密码输入弹窗 -->
      <div id="passwordModal" class="password-modal" onclick="closePasswordModal()">
        <div class="password-modal-content" onclick="event.stopPropagation()">
          <h3>请输入开发者密码</h3>
          <input type="password" id="passwordInput" placeholder="请输入密码" maxlength="20"
            onkeypress="if(event.key==='Enter') checkPassword()">
          <div class="modal-buttons">
            <button class="confirm-btn" onclick="checkPassword()">确认</button>
            <button class="cancel-btn" onclick="closePasswordModal()">取消</button>
          </div>
        </div>
      </div>

      <!-- 管理员密码弹窗 -->
      <div id="adminPasswordModal" class="password-modal" onclick="closeAdminPasswordModal()">
        <div class="password-modal-content" onclick="event.stopPropagation()">
          <h3>请输入管理员密码</h3>
          <input type="password" id="adminPasswordInput" placeholder="请输入管理员密码" maxlength="20"
            onkeypress="if(event.key==='Enter') checkAdminPassword()">
          <div class="modal-buttons">
            <button class="confirm-btn" onclick="checkAdminPassword()">确认</button>
            <button class="cancel-btn" onclick="closeAdminPasswordModal()">取消</button>
          </div>
        </div>
      </div>

      <!-- 概率展示弹窗 -->
      <div id="probabilityModal" class="password-modal" onclick="closeProbabilityModal()">
        <div class="password-modal-content" onclick="event.stopPropagation()">
          <h3>奖项概率（随时调整请留意）</h3>
          <div id="probabilityList" class="probability-list"></div>
          <div class="modal-buttons">
            <button class="cancel-btn" onclick="closeProbabilityModal()" style="width: 100%;">关闭</button>
          </div>
        </div>
      </div>

      <!-- 留言编辑弹窗（仅“小稳神”可见操作入口） -->
      <div id="messageEditModal" class="password-modal" onclick="closeMessageEditModal()">
        <div class="password-modal-content" onclick="event.stopPropagation()">
          <h3>编辑留言</h3>
          <input type="hidden" id="messageEditId" />
          <textarea id="messageEditText"
            style="width:100%;min-height:120px;resize:vertical;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;line-height:1.5;margin-bottom:15px;"></textarea>
          <div class="modal-buttons">
            <button class="confirm-btn" onclick="saveMessageEdit()">保存</button>
            <button class="cancel-btn" onclick="closeMessageEditModal()">取消</button>
          </div>
        </div>
      </div>

      <!-- 奖品展示 -->
      <div class="prizes-section">
        <div class="prizes-grid" id="prizesGrid">
          <div class="prize-item">520元</div>
          <div class="prize-item">100元</div>
          <div class="prize-item">25元</div>
          <div class="prize-item">10元</div>
          <div class="prize-item">1元</div>
          <div class="prize-item">0.52元</div>
          <div class="prize-item">0.1元</div>
          <div class="prize-item">0.01元</div>
          <div class="prize-item">谢谢参与</div>
        </div>
      </div>

      <!-- 抽奖按钮区域 -->
      <div class="draw-section">
        <div class="probability-link" onclick="showProbabilityModal()">查看概率</div>
        <div class="draw-info-top" id="drawInfo">今日剩余抽奖次数: <span id="remainingCount">5</span> 次</div>
        <button id="drawButton" class="draw-button" onclick="drawPrize()">抽奖</button>
      </div>

      <!-- 记录选项卡 -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('my')">我的记录</button>
        <button class="tab" onclick="switchTab('all')">他人记录</button>
        <button class="tab" onclick="switchTab('msg')">留言</button>
      </div>

      <!-- 记录列表 -->
      <div id="recordsPanel" class="records-section">
        <div id="myRecords" class="records-list">
          <div class="loading">加载中...</div>
        </div>
        <div id="allRecords" class="records-list hidden">
          <div class="loading">加载中...</div>
        </div>
      </div>

      <!-- 留言面板 -->
      <div id="messagePanel" class="message-panel hidden">
        <div id="messageList" class="message-list">
          <div class="loading">加载中...</div>
        </div>
        <div class="message-ticker" title="提示：鼠标悬停可暂停滚动">
          <div class="message-ticker-track">
            严禁发布违法违规、涉黄涉赌、暴力辱骂及任何不当言论；请文明发言，违者将删除内容并封禁账号，必要时配合相关部门处理。
          </div>
        </div>
        <div class="message-composer">
          <input id="messageInput" class="message-input" type="text" placeholder="请输入留言…" maxlength="200" />
          <button id="messageSendBtn" class="message-send" onclick="sendMessage()">发送</button>
        </div>
      </div>
    </div>

    <!-- 管理员后台（全屏） -->
    <div id="adminSection" class="admin-section hidden">
      <div class="admin-header">
        <h2>管理员后台</h2>
        <button type="button" class="admin-exit-btn" onclick="exitAdminPanel()">退出管理员</button>
      </div>
      <div class="admin-tabs">
        <button type="button" class="admin-tab active" data-tab="quota">抽奖次数</button>
        <button type="button" class="admin-tab" data-tab="winnings">中奖汇总</button>
        <button type="button" class="admin-tab" data-tab="prizes">奖项概率</button>
        <button type="button" class="admin-tab" data-tab="preset">预设奖项</button>
        <button type="button" class="admin-tab" data-tab="records">记录管理</button>
      </div>
      <div class="admin-content">
        <!-- 抽奖次数 -->
        <div id="adminTabQuota" class="admin-tab-panel active">
          <p class="admin-hint">设置指定用户今日剩余抽奖次数（覆盖按记录计算的次数）</p>
          <div class="admin-form-row">
            <input type="text" id="adminQuotaUsername" placeholder="用户名" maxlength="20" />
            <input type="number" id="adminQuotaRemaining" placeholder="剩余次数" min="0" />
            <button type="button" class="admin-btn" onclick="adminSaveQuota()">保存</button>
          </div>
        </div>
        <!-- 中奖汇总 -->
        <div id="adminTabWinnings" class="admin-tab-panel">
          <p class="admin-hint">今日中奖金额与历史总中奖金额（按用户汇总）</p>
          <button type="button" class="admin-btn" onclick="adminLoadWinnings()">刷新汇总</button>
          <div id="adminWinningsList" class="admin-table-wrap"></div>
        </div>
        <!-- 奖项概率 -->
        <div id="adminTabPrizes" class="admin-tab-panel">
          <p class="admin-hint">修改奖项名称、真实概率（0~1 小数）和展示概率（任意字符串）</p>
          <div id="adminPrizesList"></div>
          <button type="button" class="admin-btn" onclick="adminSavePrizes()">保存奖项配置</button>
        </div>
        <!-- 预设奖项 -->
        <div id="adminTabPreset" class="admin-tab-panel">
          <p class="admin-hint">为指定用户预设接下来最多 5 次抽奖要中的奖项（从上到下依次生效）</p>
          <div class="admin-form-row">
            <input type="text" id="adminPresetUsername" placeholder="用户名" maxlength="20" />
          </div>
          <div class="admin-form-row" id="adminPresetPrizesRow">
            <select class="preset-prize-select"></select>
            <select class="preset-prize-select"></select>
            <select class="preset-prize-select"></select>
            <select class="preset-prize-select"></select>
            <select class="preset-prize-select"></select>
          </div>
          <button type="button" class="admin-btn" onclick="adminSavePresetPrizes()">保存预设奖项</button>
          <div class="admin-hint" style="margin-top:14px;">当前预设列表（可随时修改或删除）：</div>
          <div id="adminPresetList" class="admin-table-wrap"></div>
        </div>
        <!-- 记录管理 -->
        <div id="adminTabRecords" class="admin-tab-panel">
          <p class="admin-hint">查看/删除/修改每条抽奖记录</p>
          <input type="text" id="adminRecordsUsername" placeholder="按用户名筛选（留空为全部）" />
          <button type="button" class="admin-btn" onclick="adminLoadRecords()">加载记录</button>
          <div id="adminRecordsList" class="admin-table-wrap"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 版权信息 -->
  <div class="footer">
    <div class="copyright">Beta-v1.0.3 | 反馈QQ邮箱：3253952854@qq.com</div>
  </div>

  <!-- LeanCloud SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>

  <script>
    // LeanCloud 配置 - 需要替换为您的实际 AppID 和 AppKey
    const APP_ID = 'Em8tisJ7TQ49O0TapPHhuCLy-gzGzoHsz';
    const APP_KEY = 'C9q5IAIPSwhId23glTf8g8eg';

    // 初始化 LeanCloud
    try {
      AV.init({
        appId: APP_ID,
        appKey: APP_KEY,
        serverURL: 'https://em8tisj7.lc-cn-n1-shared.com' // 国内版需要设置此参数
      });
      console.log('LeanCloud 初始化成功');
    } catch (error) {
      console.error('LeanCloud 初始化失败:', error);
      alert('LeanCloud 配置错误，请检查 AppID 和 AppKey');
    }

    // 全局变量
    let currentUsername = '';
    let todayDrawCount = 0;
    const MAX_DAILY_DRAWS = 5;
    let isDeveloperMode = false;
    const DEVELOPER_PASSWORD = '475397';
    const ADMIN_PASSWORD = '397520';
    let isAdminMode = false;
    let currentDateString = ''; // 用于检测跨天
    let dateCheckInterval = null; // 跨天检测定时器

    let PRIZES = [
      { name: '520元', probability: 0 / 100, displayProbability: "0.0008%" },
      { name: '100元', probability: 0 / 100, displayProbability: "0.008%" },
      { name: '52元', probability: 0 / 100, displayProbability: "0.08%" },
      { name: '10元', probability: 0 / 100, displayProbability: "0.8%" },
      { name: '1元', probability: 0.8 / 100, displayProbability: "1.8%" },
      { name: '0.52元', probability: 1.8 / 100, displayProbability: "2.8%" },
      { name: '0.1元', probability: 12.8 / 100, displayProbability: "18.8%" },
      { name: '0.01元', probability: 38 / 100, displayProbability: "38%" },
      { name: '谢谢参与', probability: 46.6 / 100, displayProbability: "38.8%" }
    ];


    // AppConfig：从 LeanCloud 读取/写入全局配置（key/value 字符串）
    async function getAppConfig(key) {
      try {
        const Config = AV.Object.extend('AppConfig');
        const query = new AV.Query(Config);
        query.equalTo('key', key);
        const result = await query.first();
        return result ? result.get('value') : null;
      } catch (e) {
        console.error('getAppConfig error:', e);
        return null;
      }
    }

    async function setAppConfig(key, value) {
      try {
        const Config = AV.Object.extend('AppConfig');
        const query = new AV.Query(Config);
        query.equalTo('key', key);
        let obj = await query.first();
        if (!obj) {
          obj = new Config();
          obj.set('key', key);
        }
        obj.set('value', value);
        await obj.save();
        return true;
      } catch (e) {
        console.error('setAppConfig error:', e);
        return false;
      }
    }

    // DrawQuotaOverride（LeanCloud）：每人每日剩余抽奖次数，次日 0 点无记录则视为新一天重置为 5 次
    async function getDrawCountRecord(username, drawDate) {
      try {
        const Quota = AV.Object.extend('DrawQuotaOverride');
        const query = new AV.Query(Quota);
        query.equalTo('username', username);
        query.equalTo('drawDate', drawDate);
        return await query.first();
      } catch (e) {
        console.error('getDrawCountRecord error:', e);
        return null;
      }
    }

    async function createDrawCountRecord(username, drawDate, remainingCount) {
      try {
        const Quota = AV.Object.extend('DrawQuotaOverride');
        const obj = new Quota();
        obj.set('username', username);
        obj.set('drawDate', drawDate);
        obj.set('remainingCount', remainingCount);
        await obj.save();
        return obj;
      } catch (e) {
        console.error('createDrawCountRecord error:', e);
        return null;
      }
    }

    /** 获取今日剩余次数（无记录则创建为 5 次，即次日重置） */
    async function getOrSetTodayRemaining(username) {
      const today = getTodayString();
      let record = await getDrawCountRecord(username, today);
      if (!record) {
        record = await createDrawCountRecord(username, today, MAX_DAILY_DRAWS);
        return record ? record.get('remainingCount') : MAX_DAILY_DRAWS;
      }
      return record.get('remainingCount');
    }

    async function getDrawQuotaOverride(username, drawDate) {
      const record = await getDrawCountRecord(username, drawDate);
      return record ? record.get('remainingCount') : null;
    }

    async function setDrawQuotaOverride(username, drawDate, remainingCount) {
      try {
        const today = getTodayString();
        let record = await getDrawCountRecord(username, drawDate);
        if (!record) {
          record = await createDrawCountRecord(username, drawDate, remainingCount);
          return !!record;
        }
        record.set('remainingCount', Math.max(0, parseInt(remainingCount, 10)));
        await record.save();
        return true;
      } catch (e) {
        console.error('setDrawQuotaOverride error:', e);
        return false;
      }
    }

    // 根据奖品名称解析金额（元）
    function parsePrizeToYuan(prizeName) {
      if (!prizeName || prizeName === '谢谢参与') return 0;
      const m = String(prizeName).match(/([\d.]+)\s*元/);
      return m ? parseFloat(m[1]) || 0 : 0;
    }

    // 用 PRIZES 渲染奖品网格
    function renderPrizesGrid() {
      const grid = document.getElementById('prizesGrid');
      if (!grid) return;
      grid.innerHTML = '';
      PRIZES.forEach((p) => {
        const div = document.createElement('div');
        div.className = 'prize-item';
        div.textContent = p.name;
        grid.appendChild(div);
      });
    }

    // 加载管理员配置到主页面（奖品、滚动条、弹窗公告）
    async function loadAdminConfig() {
      try {
        const prizesJson = await getAppConfig('prizes');
        if (prizesJson) {
          const arr = JSON.parse(prizesJson);
          if (Array.isArray(arr) && arr.length > 0) PRIZES = arr;
          renderPrizesGrid();
        }
        const tickerText = await getAppConfig('tickerText');
        const tickerEl = document.getElementById('siteTickerText');
        if (tickerEl && tickerText != null && tickerText !== '') tickerEl.textContent = tickerText;
        const annJson = await getAppConfig('announcement');
        if (annJson) {
          const ann = JSON.parse(annJson);
          if (ann && ann.enabled && ann.content && document.getElementById('adminAnnouncementModal')) {
            document.getElementById('adminAnnouncementContent').textContent = ann.content;
            document.getElementById('adminAnnouncementModal').classList.add('show');
          }
        }
      } catch (e) {
        console.error('loadAdminConfig error:', e);
      }
    }

    function closeAdminAnnouncement() {
      const modal = document.getElementById('adminAnnouncementModal');
      if (modal) modal.classList.remove('show');
    }

    // 检测是否跨天，如果跨天则重置抽奖次数
    function checkDateChange() {
      const today = getTodayString();
      if (currentDateString && currentDateString !== today) {
        // 跨天了，重置抽奖次数
        console.log('检测到跨天，重置抽奖次数');
        todayDrawCount = 0;
        currentDateString = today;
        if (!isDeveloperMode) {
          loadTodayDrawCount();
        }
      } else if (!currentDateString) {
        // 首次设置
        currentDateString = today;
      }
    }

    // 启动跨天检测定时器（每分钟检查一次）
    function startDateCheckTimer() {
      // 清除已有定时器
      if (dateCheckInterval) {
        clearInterval(dateCheckInterval);
      }
      // 立即检查一次
      checkDateChange();
      // 每分钟检查一次
      dateCheckInterval = setInterval(checkDateChange, 60000); // 60000ms = 1分钟
    }

    // 页面加载时检查用户名和开发者模式
    window.onload = function () {
      maybeShowNotice();
      const savedUsername = localStorage.getItem('username');
      const savedDeveloperMode = localStorage.getItem('isDeveloperMode');
      if (savedUsername) {
        currentUsername = savedUsername;
        updateWatermark(currentUsername);
        if (savedDeveloperMode === 'true') {
          isDeveloperMode = true;
        }
        showMainSection();
        loadAdminConfig(); // 加载管理员配置：奖品、滚动条、弹窗公告
        currentDateString = getTodayString();
        startDateCheckTimer();
        loadTodayDrawCount();
        loadRecords('my');
      }
    };

    // 页面可见性变化时检测跨天（用户从其他标签页切回来时）
    document.addEventListener('visibilitychange', function () {
      if (!document.hidden && currentUsername) {
        // 页面变为可见时，立即检查是否跨天
        checkDateChange();
      }
    });

    // ============================
    // 水印配置（可通过代码自由修改）
    // ============================
    // 说明：
    // - fontSize: 字体大小(px)
    // - gapX/gapY: 水印水平/垂直间距(px)，越小越密
    // - angleDeg: 旋转角度(度)，例如 -30
    // - color: 颜色(r,g,b)
    // - alpha: 透明度(0~1)
    const WATERMARK_CONFIG = {
      fontSize: 14,
      gapX: 180,
      gapY: 200,
      angleDeg: -30,
      color: { r: 0, g: 0, b: 0 },
      alpha: 0.12,
      fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif",
    };

    // 可手动调用：修改 WATERMARK_CONFIG 后执行 refreshWatermark()
    function refreshWatermark() {
      updateWatermark(currentUsername);
    }

    // 获取本地日期 YYYYMMDD（避免 toISOString 的时区跨天问题）
    function getTodayCompactLocal() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}${m}${day}`;
    }

    // 生成并更新水印（用 Canvas 生成可重复背景）
    function updateWatermark(text) {
      const layer = document.getElementById('watermarkLayer');
      if (!layer) return;
      const t = (text || '').trim();
      if (!t) {
        layer.style.backgroundImage = '';
        layer.style.backgroundSize = '';
        layer.style.display = 'none';
        return;
      }

      // 水印内容：用户名 + 今日日期（YYYYMMDD）
      const watermarkText = `${t}${getTodayCompactLocal()}`;

      const canvas = document.createElement('canvas');
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const w = Math.max(120, WATERMARK_CONFIG.gapX) * dpr;
      const h = Math.max(90, WATERMARK_CONFIG.gapY) * dpr;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      ctx.clearRect(0, 0, w, h);
      ctx.save();
      ctx.translate(w / 2, h / 2);
      ctx.rotate((WATERMARK_CONFIG.angleDeg * Math.PI) / 180);
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const { r, g, b } = WATERMARK_CONFIG.color;
      ctx.fillStyle = `rgba(${r},${g},${b},${WATERMARK_CONFIG.alpha})`;
      ctx.font = `${WATERMARK_CONFIG.fontSize * dpr}px ${WATERMARK_CONFIG.fontFamily}`;
      ctx.fillText(watermarkText, 0, 0);
      ctx.restore();

      layer.style.backgroundImage = `url(${canvas.toDataURL('image/png')})`;
      layer.style.backgroundSize = `${WATERMARK_CONFIG.gapX}px ${WATERMARK_CONFIG.gapY}px`;
      layer.style.display = 'block';
    }

    // ============================
    // 公告弹窗（每日一次）
    // ============================
    const NOTICE_SKIP_KEY = 'notice_skip_date_v1';

    function getNoticeText() {
      return `
使用须知：
1.切勿造假，发现后将封禁测试账号。测试用户资格发放有限，仅前三天可参与兑奖。请在当日24：00前兑奖。
2.本APP承诺不获取、不收集、不存储用户隐私信息，也不会向任何第三方提供或出售任何用户数据。
3.未经许可，禁止对本应用进行反编译、破解、篡改或进行任何形式的逆向工程。
4.抽奖为概率性活动，开奖结果以系统公示结果为准。
5.本活动/抽奖由本APP开发者主办并负责解释与执行，如发现安全漏洞或异常行为反馈至3253952854@qq.com，我们将及时处理。
6.本条款未尽事宜以最新《用户协议》与《服务规则》为准，并适用相关法律法规。
7.使用则代表您以仔细阅读并同意!`;
    }

    function maybeShowNotice() {
      const modal = document.getElementById('noticeModal');
      const content = document.getElementById('noticeContent');
      if (!modal || !content) return;

      const today = getTodayString();
      const skipped = localStorage.getItem(NOTICE_SKIP_KEY);
      if (skipped === today) return;

      content.textContent = getNoticeText();
      modal.classList.add('show');
    }

    function agreeNotice() {
      const modal = document.getElementById('noticeModal');
      const checkbox = document.getElementById('noticeSkipToday');
      if (!modal) return;

      if (checkbox && checkbox.checked) {
        localStorage.setItem(NOTICE_SKIP_KEY, getTodayString());
      }
      modal.classList.remove('show');
    }

    function limitUsernameLength() {
      const input = document.getElementById('usernameInput');
      if (!input) return;
      const v = input.value || '';
      if (v.length > 6) input.value = v.slice(0, 6);
    }

    // 保存用户名
    async function saveUsername() {
      limitUsernameLength();
      const username = document.getElementById('usernameInput').value.trim();
      if (!username) {
        alert('请输入用户名');
        return;
      }
      if (username.length > 6) {
        alert('用户名最多6个字'); return;
      }

      currentUsername = username;
      localStorage.setItem('username', username);
      updateWatermark(currentUsername);
      showMainSection();
      await loadTodayDrawCount();
      await loadRecords('my');
    }

    // 显示主抽奖区域
    function showMainSection() {
      document.getElementById('usernameSection').classList.add('hidden');
      document.getElementById('mainSection').classList.remove('hidden');
      updateNavbarDisplay();
      // 为导航栏 + 顶部公告条预留顶部间距
      document.getElementById('mainSection').style.paddingTop = '90px';
    }

    // 更新导航栏显示
    function updateNavbarDisplay() {
      const displayUsername = document.getElementById('displayUsername');
      const developerMenuItem = document.getElementById('developerMenuItem');
      const exitDeveloperMenuItem = document.getElementById('exitDeveloperMenuItem');

      if (isDeveloperMode) {
        displayUsername.textContent = '开发者';
        developerMenuItem.classList.add('hidden');
        exitDeveloperMenuItem.classList.remove('hidden');
      } else {
        displayUsername.textContent = currentUsername;
        developerMenuItem.classList.remove('hidden');
        exitDeveloperMenuItem.classList.add('hidden');
      }
    }

    // 加载今日抽奖次数（从 LeanCloud 读取，无记录则创建为 5 次，次日 0 点自然重置）
    async function loadTodayDrawCount() {
      try {
        const drawButton = document.getElementById('drawButton');
        if (isDeveloperMode) {
          document.getElementById('remainingCount').textContent = '∞';
          drawButton.disabled = false;
          document.getElementById('drawInfo').textContent = '开发者模式：无限次抽奖';
          return;
        }

        checkDateChange();
        const remaining = await getOrSetTodayRemaining(currentUsername);
        const n = Math.max(0, parseInt(remaining, 10));
        todayDrawCount = MAX_DAILY_DRAWS - n;

        document.getElementById('remainingCount').textContent = n;
        drawButton.disabled = n <= 0;
        document.getElementById('drawInfo').textContent = `今日剩余抽奖次数: ${n} 次`;
      } catch (error) {
        console.error('加载抽奖次数失败:', error);
      }
    }

    // 获取今天的日期字符串（YYYY-MM-DD，使用本地时区）
    function getTodayString() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // 获取指定日期的日期字符串（YYYY-MM-DD，本地时区）
    function getDateStringFromDate(date) {
      const d = date instanceof Date ? date : new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // 格式化时间（年-月-日 时:分:秒）
    function formatDateTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // 抽奖逻辑
    async function drawPrize() {
      if (!isDeveloperMode && todayDrawCount >= MAX_DAILY_DRAWS) {
        alert('今日抽奖次数已用完，请明天再来！');
        return;
      }

      // 禁用按钮
      const drawButton = document.getElementById('drawButton');
      drawButton.disabled = true;
      drawButton.textContent = '抽奖中...';

      const prizeItems = document.querySelectorAll('.prize-item');

      // 尝试从“预设奖项队列”中取出下一次要中的奖项名称（如无则返回 null）
      async function getNextPrizeForUser() {
        try {
          const Plan = AV.Object.extend('UserPrizePlan');
          const query = new AV.Query(Plan);
          query.equalTo('username', currentUsername);
          const obj = await query.first();
          if (!obj) return null;
          const raw = obj.get('prizesJson') || '[]';
          let arr;
          try {
            arr = JSON.parse(raw);
          } catch {
            arr = [];
          }
          if (!Array.isArray(arr) || arr.length === 0) {
            await obj.destroy();
            return null;
          }
          const nextName = arr.shift();
          if (arr.length === 0) {
            await obj.destroy();
          } else {
            obj.set('prizesJson', JSON.stringify(arr));
            await obj.save();
          }
          if (!nextName) return null;
          return nextName;
        } catch (e) {
          // 404 表示表不存在，视为无预设
          if (e.code === 404 || e.status === 404) return null;
          console.error('getNextPrizeForUser error:', e);
          return null;
        }
      }

      if (isDeveloperMode) {
        // 开发者模式：直接显示结果，无动画
        const plannedName = await getNextPrizeForUser();
        const prize = plannedName ? { name: plannedName } : calculatePrize();

        // 高亮显示中奖项
        prizeItems.forEach((item) => {
          item.classList.remove('highlight');
          if (item.textContent === prize.name) {
            item.classList.add('highlight');
          }
        });

        // 保存记录到 LeanCloud
        const saveSuccess = await saveDrawRecord(prize.name);

        // 开发者模式：立即恢复按钮可用
        drawButton.disabled = false;
        drawButton.textContent = '抽奖';

        // 如果保存成功，重新加载记录
        if (saveSuccess) {
          await loadRecords('my');
        }

        // 短暂显示高亮后清除
        setTimeout(() => {
          prizeItems.forEach(item => item.classList.remove('highlight'));
        }, 500);
      } else {
        // 用户模式：有动画，时间缩短
        // 先获取预设奖项（如果有），以便在动画结束时直接跳到预设奖项
        const plannedName = await getNextPrizeForUser();
        const hasPlannedPrize = !!plannedName;
        
        let currentIndex = 0;
        // 动画参数：根据奖项数量动态计算，确保能跑到最后一项（例如 0.01 元不会被跳过）
        const animationStepMs = 80; // 每步间隔（越小越快）
        const animationDurationMs = Math.max(
          520,
          prizeItems.length * animationStepMs + 80 // 至少完整走一圈 + 少量缓冲
        );
        let animationInterval = null;
        let animationTimeout = null;
        
        // 统一的完成抽奖函数（定义在使用之前）
        async function finishDrawWithPrize(prizeName) {
          try {
            const prize = { name: prizeName };

            // 高亮显示中奖项
            prizeItems.forEach((item) => {
              item.classList.remove('highlight');
              if (item.textContent === prize.name) {
                item.classList.add('highlight');
              }
            });

            // 保存记录到 LeanCloud
            let saveSuccess = false;
            try {
              saveSuccess = await saveDrawRecord(prize.name);
            } catch (error) {
              console.error('保存记录时出错:', error);
              saveSuccess = false;
            }

            // 扣减 LeanCloud 中今日剩余次数
            const today = getTodayString();
            let record = await getDrawCountRecord(currentUsername, today);
            if (!record) record = await createDrawCountRecord(currentUsername, today, MAX_DAILY_DRAWS);
            if (record) {
              const nowRemaining = Math.max(0, (record.get('remainingCount') || 0) - 1);
              record.set('remainingCount', nowRemaining);
              await record.save();
              todayDrawCount = MAX_DAILY_DRAWS - nowRemaining;
            } else {
              todayDrawCount++;
            }

            const remaining = MAX_DAILY_DRAWS - todayDrawCount;
            const remainingCountEl = document.getElementById('remainingCount');
            const drawInfoEl = document.getElementById('drawInfo');

            if (remainingCountEl) remainingCountEl.textContent = remaining;
            if (drawInfoEl) drawInfoEl.textContent = `今日剩余抽奖次数: ${remaining} 次`;
            if (drawButton) {
              drawButton.disabled = remaining <= 0;
              drawButton.textContent = '抽奖';
            }

            // 重新加载记录（无论保存是否成功都尝试加载）
            try {
              await loadRecords('my');
            } catch (error) {
              console.error('加载记录时出错:', error);
            }

            // 显示中奖提示
            setTimeout(() => {
              if (!saveSuccess) {
                alert(`抽中：${prize.name}，保存失败，请将此提示截屏联系管理员并稍后重试`);
              }
              prizeItems.forEach(item => item.classList.remove('highlight'));
            }, 500);
          } catch (error) {
            console.error('抽奖过程中出错:', error);
            console.error('错误详情:', error.message, error.stack);
            // 确保按钮状态恢复
            if (drawButton) {
              drawButton.disabled = false;
              drawButton.textContent = '抽奖';
            }
            const remainingCountEl = document.getElementById('remainingCount');
            const drawInfoEl = document.getElementById('drawInfo');
            const remaining = MAX_DAILY_DRAWS - todayDrawCount;

            if (remainingCountEl) {
              remainingCountEl.textContent = remaining;
            }
            if (drawInfoEl) {
              drawInfoEl.textContent = `今日剩余抽奖次数: ${remaining} 次`;
            }
            prizeItems.forEach(item => item.classList.remove('highlight'));
            alert('抽奖过程中出现错误：' + (error.message || '未知错误'));
          }
        }
        
        // 动画循环函数
        const animateStep = () => {
          prizeItems.forEach(item => item.classList.remove('highlight'));
          prizeItems[currentIndex].classList.add('highlight');
          
          // 如果有预设奖项，且当前显示的是最后一个奖项（索引为 prizeItems.length - 1），停止动画并跳到预设奖项
          if (hasPlannedPrize && currentIndex === prizeItems.length - 1) {
            // 已经转到最后一个奖项，停止动画
            clearInterval(animationInterval);
            clearTimeout(animationTimeout);
            animationInterval = null;
            
            // 直接跳到预设奖项
            finishDrawWithPrize(plannedName);
            return; // 不再继续循环
          }
          
          currentIndex = (currentIndex + 1) % prizeItems.length;
        };
        
        animationInterval = setInterval(animateStep, animationStepMs);

        // 动画结束后停止并确定奖项（如果没有预设奖项或动画提前结束）
        animationTimeout = setTimeout(async () => {
          if (animationInterval) {
            clearInterval(animationInterval);
            animationInterval = null;
          }

          try {
            // 如果动画自然结束，使用预设奖项（如果之前没用到）或按概率计算
            const finalPlannedName = hasPlannedPrize ? plannedName : await getNextPrizeForUser();
            const prize = finalPlannedName ? { name: finalPlannedName } : calculatePrize();
            finishDrawWithPrize(prize.name);
          } catch (error) {
            console.error('抽奖过程中出错:', error);
            // 确保按钮状态恢复
            if (drawButton) {
              drawButton.disabled = false;
              drawButton.textContent = '抽奖';
            }
          }
        }, animationDurationMs);
      }
    }

    // 根据概率计算奖项
    function calculatePrize() {
      const random = Math.random();
      let cumulativeProbability = 0;

      for (const prize of PRIZES) {
        cumulativeProbability += prize.probability;
        if (random <= cumulativeProbability) {
          return prize;
        }
      }

      // 如果所有概率都没匹配到，返回最后一个（谢谢参与）
      return PRIZES[PRIZES.length - 1];
    }

    // 保存抽奖记录
    async function saveDrawRecord(prizeName) {
      if (isDeveloperMode) {
        // 开发者模式：保存到本地存储
        try {
          const record = {
            username: currentUsername,
            prize: prizeName,
            drawDate: getTodayString(),
            drawTime: new Date().toISOString(),
            isDeveloper: true
          };

          // 获取现有的本地记录
          const localRecords = JSON.parse(localStorage.getItem('developerRecords') || '[]');
          localRecords.push(record);

          // 保存到本地存储（最多保留1000条记录）
          if (localRecords.length > 1000) {
            localRecords.shift();
          }
          localStorage.setItem('developerRecords', JSON.stringify(localRecords));

          console.log('开发者记录保存到本地成功');
          return true;
        } catch (error) {
          console.error('保存本地记录失败:', error);
          return false;
        }
      } else {
        // 用户模式：保存到 LeanCloud
        try {
          const DrawRecord = AV.Object.extend('DrawRecord');
          const record = new DrawRecord();

          record.set('username', currentUsername);
          record.set('prize', prizeName);
          record.set('drawDate', getTodayString());
          record.set('drawTime', new Date());
          record.set('isDeveloper', false);

          await record.save();
          console.log('记录保存成功');
          return true;
        } catch (error) {
          console.error('保存记录失败:', error);

          // 更详细的错误信息
          let errorMsg = '保存记录失败：';
          if (error.code === 1) {
            errorMsg += '网络连接失败，请检查网络';
          } else if (error.code === 403) {
            errorMsg += '权限不足，请检查LeanCloud数据表权限设置';
          } else if (error.code === 400) {
            errorMsg += '请求参数错误，请检查配置';
          } else if (error.message) {
            errorMsg += error.message;
          } else {
            errorMsg += '未知错误，请检查控制台';
          }

          alert(errorMsg);
          return false;
        }
      }
    }

    // 切换选项卡
    function switchTab(tab) {
      // 更新选项卡样式
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // 显示对应的记录列表
      const recordsPanel = document.getElementById('recordsPanel');
      const messagePanel = document.getElementById('messagePanel');

      if (tab === 'msg') {
        if (recordsPanel) recordsPanel.classList.add('hidden');
        if (messagePanel) messagePanel.classList.remove('hidden');
        loadMessages();
        startMessageCooldownCountdown();
        return;
      }

      if (messagePanel) messagePanel.classList.add('hidden');
      if (recordsPanel) recordsPanel.classList.remove('hidden');

      if (tab === 'my') {
        document.getElementById('myRecords').classList.remove('hidden');
        document.getElementById('allRecords').classList.add('hidden');
        loadRecords('my');
      } else {
        document.getElementById('myRecords').classList.add('hidden');
        document.getElementById('allRecords').classList.remove('hidden');
        loadRecords('all');
      }
    }

    // ==============
    // 留言（所有人可见）
    // ==============
    async function loadMessages() {
      const list = document.getElementById('messageList');
      if (!list) return;
      list.innerHTML = '<div class="loading">加载中...</div>';

      try {
        const Message = AV.Object.extend('Message');
        const query = new AV.Query(Message);
        query.descending('createdAt');
        query.limit(100);
        const results = await query.find();

        if (!results || results.length === 0) {
          list.innerHTML = '<div class="empty-records">暂无留言</div>';
          return;
        }

        list.innerHTML = '';
        results.forEach((m) => {
          const username = m.get('username') || '';
          const content = m.get('content') || '';
          const timeStr = formatDateTime(new Date(m.createdAt));
          const id = m.id;
          const isAdmin = currentUsername === '小稳神';

          const card = document.createElement('div');
          card.className = 'message-card';
          card.innerHTML = `
            ${isAdmin ? `
              <div class="message-actions">
                <button class="message-action-btn" onclick="openMessageEdit('${id}')">编辑</button>
                <button class="message-action-btn danger" onclick="deleteMessage('${id}')">删除</button>
              </div>
            ` : ''}
            <div class="message-meta">
              <span class="message-user">${escapeHtml(username)}</span>
              <span class="message-time">${timeStr}</span>
            </div>
            <div class="message-text">${escapeHtml(content)}</div>
          `;
          list.appendChild(card);
        });
      } catch (error) {
        console.error('加载留言失败:', error);
        list.innerHTML = '<div class="empty-records">加载失败，请稍后重试</div>';
      }
    }

    // 留言发送频率控制（每个用户 120 秒一次）
    const MESSAGE_COOLDOWN_SECONDS = 120;
    let messageCooldownTimer = null;

    function getMessageCooldownKey() {
      return `message_last_sent_at_v1::${currentUsername || ''}`;
    }

    function getRemainingMessageCooldownSeconds() {
      if (!currentUsername) return 0;
      const key = getMessageCooldownKey();
      const last = Number(localStorage.getItem(key) || '0');
      if (!last) return 0;
      const elapsedMs = Date.now() - last;
      const remainingMs = MESSAGE_COOLDOWN_SECONDS * 1000 - elapsedMs;
      return Math.max(0, Math.ceil(remainingMs / 1000));
    }

    function updateMessageSendButtonState() {
      const btn = document.getElementById('messageSendBtn');
      if (!btn) return;
      const remaining = getRemainingMessageCooldownSeconds();
      if (remaining > 0) {
        btn.disabled = true;
        btn.textContent = `${remaining}s 后可发送`;
      } else {
        btn.disabled = false;
        btn.textContent = '发送';
      }
    }

    function startMessageCooldownCountdown() {
      if (messageCooldownTimer) {
        clearInterval(messageCooldownTimer);
        messageCooldownTimer = null;
      }
      updateMessageSendButtonState();
      messageCooldownTimer = setInterval(() => {
        const remaining = getRemainingMessageCooldownSeconds();
        updateMessageSendButtonState();
        if (remaining <= 0) {
          clearInterval(messageCooldownTimer);
          messageCooldownTimer = null;
        }
      }, 500);
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const btn = document.getElementById('messageSendBtn');
      if (!input || !btn) return;

      // 冷却中不允许发送
      const remaining = getRemainingMessageCooldownSeconds();
      if (remaining > 0) {
        startMessageCooldownCountdown();
        return;
      }

      const content = (input.value || '').trim();
      if (!content) return;

      btn.disabled = true;
      btn.textContent = '发送中...';

      try {
        const Message = AV.Object.extend('Message');
        const msg = new Message();
        msg.set('username', currentUsername);
        msg.set('content', content);
        await msg.save();

        input.value = '';
        await loadMessages();

        // 记录本次发送时间并开始倒计时
        localStorage.setItem(getMessageCooldownKey(), String(Date.now()));
        startMessageCooldownCountdown();
      } catch (error) {
        console.error('发送留言失败:', error);
        alert('发送失败，请检查网络或权限设置');
      } finally {
        // 如果进入冷却则保持禁用并显示倒计时，否则恢复发送
        updateMessageSendButtonState();
      }
    }

    function openMessageEdit(id) {
      if (currentUsername !== '小稳神') return;
      const modal = document.getElementById('messageEditModal');
      const idEl = document.getElementById('messageEditId');
      const textEl = document.getElementById('messageEditText');
      if (!modal || !idEl || !textEl) return;

      // 从当前列表中取出原文（避免额外请求）
      const card = Array.from(document.querySelectorAll('.message-card')).find(c => c.querySelector('.message-actions button')?.getAttribute('onclick')?.includes(id));
      let currentText = '';
      if (card) {
        const textNode = card.querySelector('.message-text');
        currentText = textNode ? textNode.textContent : '';
      }

      idEl.value = id;
      textEl.value = currentText;
      modal.classList.add('show');
      setTimeout(() => textEl.focus(), 0);
    }

    function closeMessageEditModal() {
      const modal = document.getElementById('messageEditModal');
      const idEl = document.getElementById('messageEditId');
      const textEl = document.getElementById('messageEditText');
      if (modal) modal.classList.remove('show');
      if (idEl) idEl.value = '';
      if (textEl) textEl.value = '';
    }

    async function saveMessageEdit() {
      if (currentUsername !== '小稳神') return;
      const idEl = document.getElementById('messageEditId');
      const textEl = document.getElementById('messageEditText');
      if (!idEl || !textEl) return;
      const id = (idEl.value || '').trim();
      const newContent = (textEl.value || '').trim();
      if (!id) return;
      if (!newContent) {
        alert('内容不能为空');
        return;
      }

      try {
        const Message = AV.Object.extend('Message');
        const msg = AV.Object.createWithoutData('Message', id);
        msg.set('content', newContent); // 只更新内容，其他字段不变
        await msg.save();
        closeMessageEditModal();
        await loadMessages();
      } catch (error) {
        console.error('编辑留言失败:', error);
        alert('编辑失败，请检查网络或权限设置');
      }
    }

    async function deleteMessage(id) {
      if (currentUsername !== '小稳神') return;
      if (!id) return;
      if (!confirm('确定要删除这条留言吗？')) return;

      try {
        const msg = AV.Object.createWithoutData('Message', id);
        await msg.destroy();
        await loadMessages();
      } catch (error) {
        console.error('删除留言失败:', error);
        alert('删除失败，请检查网络或权限设置');
      }
    }

    // 简单转义，避免留言插入 HTML
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('\"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // 加载记录
    async function loadRecords(type) {
      const container = type === 'my' ? document.getElementById('myRecords') : document.getElementById('allRecords');
      container.innerHTML = '<div class="loading">加载中...</div>';

      try {
        let allRecords = [];

        if (type === 'my') {
          // 我的记录：显示当前用户的所有记录
          // 1. 加载LeanCloud中的用户记录
          try {
            const DrawRecord = AV.Object.extend('DrawRecord');
            const query = new AV.Query(DrawRecord);
            query.equalTo('username', currentUsername);
            query.notEqualTo('isDeveloper', true); // 不加载旧的开发者记录（如果有）
            query.descending('drawTime');
            query.limit(100);
            const cloudResults = await query.find();

            cloudResults.forEach(result => {
              allRecords.push({
                prize: result.get('prize'),
                drawTime: result.get('drawTime'),
                username: result.get('username'),
                isDeveloper: false
              });
            });
          } catch (error) {
            console.error('加载LeanCloud记录失败:', error);
          }

          // 2. 只有在开发者模式下才加载本地存储的开发者记录
          if (isDeveloperMode) {
            const localRecords = JSON.parse(localStorage.getItem('developerRecords') || '[]');
            localRecords.forEach(record => {
              if (record.username === currentUsername) {
                allRecords.push({
                  prize: record.prize,
                  drawTime: new Date(record.drawTime),
                  username: record.username,
                  isDeveloper: true
                });
              }
            });
          }
        } else {
          // 他人记录：只显示LeanCloud中的非开发者记录
          const DrawRecord = AV.Object.extend('DrawRecord');
          const query = new AV.Query(DrawRecord);
          query.notEqualTo('isDeveloper', true);
          query.descending('drawTime');
          query.limit(100);
          const results = await query.find();

          results.forEach(result => {
            allRecords.push({
              prize: result.get('prize'),
              drawTime: result.get('drawTime'),
              username: result.get('username'),
              isDeveloper: false
            });
          });
        }

        // 按时间排序（最新的在前）
        allRecords.sort((a, b) => {
          const timeA = a.drawTime instanceof Date ? a.drawTime : new Date(a.drawTime);
          const timeB = b.drawTime instanceof Date ? b.drawTime : new Date(b.drawTime);
          return timeB - timeA;
        });

        // 限制显示数量
        allRecords = allRecords.slice(0, 100);

        if (allRecords.length === 0) {
          container.innerHTML = '<div class="empty-records">暂无记录</div>';
          return;
        }

        container.innerHTML = '';
        allRecords.forEach(record => {
          const recordItem = document.createElement('div');
          recordItem.className = 'record-item';

          const prize = record.prize;
          const drawTime = record.drawTime instanceof Date ? record.drawTime : new Date(record.drawTime);
          const username = record.username;
          const isDev = record.isDeveloper || false;

          // 当天 vs 历史：决定颜色（我的记录/他人记录都一致）
          const isToday = getDateStringFromDate(drawTime) === getTodayString();
          recordItem.classList.add(isToday ? 'is-today' : 'is-old');

          const timeStr = formatDateTime(drawTime);

          let html = `<div class="record-header">`;

          // 他人记录：用户名在最前面
          if (type === 'all') {
            html += `<div class="username">${username}</div>`;
          }

          html += `<div class="time">${timeStr}</div>`;
          html += `<div class="prize">${prize}`;
          if (isDev && type === 'my') {
            html += ' <span style="color: #999; font-size: 12px;">(开发者-本地)</span>';
          }
          html += `</div>`;
          html += `</div>`;

          recordItem.innerHTML = html;
          container.appendChild(recordItem);
        });
      } catch (error) {
        console.error('加载记录失败:', error);
        let errorMsg = '加载失败：';
        if (error.code === 1) {
          errorMsg += '网络连接失败';
        } else if (error.code === 403) {
          errorMsg += '权限不足，请检查数据表权限';
        } else if (error.message) {
          errorMsg += error.message;
        } else {
          errorMsg += '未知错误';
        }
        container.innerHTML = `<div class="empty-records">${errorMsg}<br>请刷新重试</div>`;
      }
    }

    // 切换下拉菜单
    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownMenu');
      dropdown.classList.toggle('show');
    }

    // 点击外部关闭下拉菜单
    document.addEventListener('click', function (event) {
      const userInfo = document.querySelector('.user-info');
      const dropdown = document.getElementById('dropdownMenu');
      if (userInfo && dropdown && !userInfo.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });

    // 打开开发者模式密码输入
    function openDeveloperMode() {
      document.getElementById('dropdownMenu').classList.remove('show');
      document.getElementById('passwordModal').classList.add('show');
      document.getElementById('passwordInput').focus();
    }

    // 关闭密码输入弹窗
    function closePasswordModal() {
      document.getElementById('passwordModal').classList.remove('show');
      document.getElementById('passwordInput').value = '';
    }

    // 显示概率弹窗
    function showProbabilityModal() {
      const modal = document.getElementById('probabilityModal');
      const list = document.getElementById('probabilityList');

      // 清空列表
      list.innerHTML = '';

      // 遍历奖品并显示概率
      PRIZES.forEach(prize => {
        const item = document.createElement('div');
        item.className = 'probability-item';

        // 使用 displayProbability 字段显示（如果存在），否则使用实际概率
        const displayText = prize.displayProbability || ((prize.probability * 100).toFixed(8) + '%');

        item.innerHTML = `
          <span class="prize-name">${prize.name}</span>
          <span class="prize-probability">${displayText}</span>
        `;

        list.appendChild(item);
      });

      modal.classList.add('show');
    }

    // 关闭概率弹窗
    function closeProbabilityModal() {
      document.getElementById('probabilityModal').classList.remove('show');
    }

    // 验证密码并进入开发者模式
    function checkPassword() {
      const password = document.getElementById('passwordInput').value.trim();
      if (password === DEVELOPER_PASSWORD) {
        isDeveloperMode = true;
        localStorage.setItem('isDeveloperMode', 'true');
        closePasswordModal();
        // 刷新页面以更新所有状态
        location.reload();
      } else {
        alert('密码错误！');
        document.getElementById('passwordInput').value = '';
      }
    }

    // 退出开发者模式
    function exitDeveloperMode() {
      isDeveloperMode = false;
      localStorage.removeItem('isDeveloperMode');
      document.getElementById('dropdownMenu').classList.remove('show');
      location.reload();
    }

    // ============== 管理员后台 ==============
    function openAdminPanel() {
      document.getElementById('dropdownMenu').classList.remove('show');
      document.getElementById('adminPasswordModal').classList.add('show');
      document.getElementById('adminPasswordInput').value = '';
      document.getElementById('adminPasswordInput').focus();
    }

    function closeAdminPasswordModal() {
      document.getElementById('adminPasswordModal').classList.remove('show');
      document.getElementById('adminPasswordInput').value = '';
    }

    function checkAdminPassword() {
      const pwd = document.getElementById('adminPasswordInput').value.trim();
      if (pwd === ADMIN_PASSWORD) {
        isAdminMode = true;
        closeAdminPasswordModal();
        document.getElementById('mainSection').classList.add('hidden');
        document.getElementById('adminSection').classList.remove('hidden');
        adminInitTabs();
        adminLoadPrizesForm();
      } else {
        alert('管理员密码错误！');
        document.getElementById('adminPasswordInput').value = '';
      }
    }

    function exitAdminPanel() {
      isAdminMode = false;
      document.getElementById('adminSection').classList.add('hidden');
      document.getElementById('mainSection').classList.remove('hidden');
    }

    function adminInitTabs() {
      document.querySelectorAll('.admin-tab').forEach((tab) => {
        tab.onclick = function () {
          const t = this.getAttribute('data-tab');
          document.querySelectorAll('.admin-tab').forEach((x) => x.classList.remove('active'));
          document.querySelectorAll('.admin-tab-panel').forEach((x) => x.classList.remove('active'));
          this.classList.add('active');
          const panel = document.getElementById('adminTab' + t.charAt(0).toUpperCase() + t.slice(1));
          if (panel) panel.classList.add('active');
          if (t === 'prizes') adminLoadPrizesForm();
          if (t === 'preset') {
            adminInitPresetPrizeOptions();
            adminLoadPresetList();
          }
        };
      });
    }

    async function adminSaveQuota() {
      const username = document.getElementById('adminQuotaUsername').value.trim();
      const remaining = document.getElementById('adminQuotaRemaining').value.trim();
      if (!username) {
        alert('请输入用户名');
        return;
      }
      const n = parseInt(remaining, 10);
      if (isNaN(n) || n < 0) {
        alert('请输入有效的剩余次数（≥0）');
        return;
      }
      const today = getTodayString();
      const ok = await setDrawQuotaOverride(username, today, n);
      if (ok) alert('已保存：' + username + ' 今日剩余抽奖次数 ' + n + ' 次');
      else alert('保存失败，请查看控制台');
    }

    async function adminLoadWinnings() {
      const listEl = document.getElementById('adminWinningsList');
      listEl.innerHTML = '<div class="loading">加载中...</div>';
      try {
        const DrawRecord = AV.Object.extend('DrawRecord');
        const query = new AV.Query(DrawRecord);
        query.notEqualTo('isDeveloper', true);
        query.limit(1000);
        const results = await query.find();
        const today = getTodayString();
        const byUser = {};
        results.forEach((r) => {
          const u = r.get('username') || '';
          const prize = r.get('prize') || '';
          const dateStr = r.get('drawDate') || getDateStringFromDate(r.get('drawTime'));
          const yuan = parsePrizeToYuan(prize);
          if (!byUser[u]) {
            byUser[u] = { today: 0, total: 0 };
          }
          byUser[u].total += yuan;
          if (dateStr === today) byUser[u].today += yuan;
        });
        const rows = Object.keys(byUser)
          .sort((a, b) => byUser[b].total - byUser[a].total)
          .map((u) => `<tr><td>${escapeHtml(u)}</td><td>${byUser[u].today.toFixed(2)} 元</td><td>${byUser[u].total.toFixed(2)} 元</td></tr>`)
          .join('');
        listEl.innerHTML = '<table class="admin-table"><thead><tr><th>用户</th><th>今日中奖</th><th>历史总中奖</th></tr></thead><tbody>' + rows + '</tbody></table>';
      } catch (e) {
        listEl.innerHTML = '<div class="empty-records">加载失败：' + (e.message || e) + '</div>';
      }
    }

    function adminLoadPrizesForm() {
      const container = document.getElementById('adminPrizesList');
      if (!container) return;
      container.innerHTML = '';
      PRIZES.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'admin-prize-row';
        div.innerHTML = `
          <input type="text" class="prize-name-inp" data-i="${i}" data-field="name" value="${escapeHtml(p.name)}" placeholder="奖项名" />
          <input type="number" class="prize-prob-inp" data-i="${i}" data-field="probability" step="0.0001" min="0" max="1" value="${p.probability}" placeholder="真实概率" />
          <input type="text" class="prize-display-inp" data-i="${i}" data-field="displayProbability" value="${escapeHtml(p.displayProbability || '')}" placeholder="展示概率" />
        `;
        container.appendChild(div);
      });
    }

    async function adminSavePrizes() {
      const rows = document.querySelectorAll('#adminPrizesList .admin-prize-row');
      const next = [];
      for (let i = 0; i < rows.length; i++) {
        const name = rows[i].querySelector('.prize-name-inp')?.value?.trim() || '奖项' + (i + 1);
        const probInp = rows[i].querySelector('.prize-prob-inp');
        const displayInp = rows[i].querySelector('.prize-display-inp');
        const prob = parseFloat(probInp?.value) || 0;
        const display = displayInp?.value?.trim() || (prob * 100).toFixed(2) + '%';
        next.push({ name, probability: prob, displayProbability: display });
      }
      if (next.length === 0) {
        alert('请至少保留一项');
        return;
      }
      PRIZES = next;
      renderPrizesGrid();
      const ok = await setAppConfig('prizes', JSON.stringify(next));
      if (ok) alert('奖项配置已保存');
      else alert('保存失败');
    }

    // 预设奖项（UserPrizePlan）
    function adminInitPresetPrizeOptions() {
      const selects = document.querySelectorAll('.preset-prize-select');
      if (!selects.length) return;
      selects.forEach((sel) => {
        const current = sel.value;
        sel.innerHTML = '';
        const emptyOpt = document.createElement('option');
        emptyOpt.value = '';
        emptyOpt.textContent = '（不设置）';
        sel.appendChild(emptyOpt);
        PRIZES.forEach((p) => {
          const opt = document.createElement('option');
          opt.value = p.name;
          opt.textContent = p.name;
          sel.appendChild(opt);
        });
        // 保持原先选择
        if (current) sel.value = current;
      });
    }

    async function adminSavePresetPrizes() {
      const username = document.getElementById('adminPresetUsername').value.trim();
      if (!username) {
        alert('请输入用户名');
        return;
      }
      const selects = document.querySelectorAll('.preset-prize-select');
      const prizes = [];
      selects.forEach((sel) => {
        const v = sel.value;
        if (v) prizes.push(v);
      });
      if (!prizes.length) {
        alert('请至少选择一个预设奖项');
        return;
      }
      try {
        const Plan = AV.Object.extend('UserPrizePlan');
        let obj = null;
        let shouldCreateNew = true;
        
        // 尝试查询现有记录（如果表不存在，query.first() 可能返回 null 或抛出错误）
        try {
          const query = new AV.Query(Plan);
          query.equalTo('username', username);
          obj = await query.first();
          if (obj) {
            // 找到了现有记录，更新它
            shouldCreateNew = false;
          }
        } catch (queryErr) {
          // 查询出错（可能是表不存在或其他错误），直接创建新对象
          console.log('查询预设奖项时出错，将创建新记录:', queryErr);
          shouldCreateNew = true;
        }
        
        // 创建新对象或使用现有对象
        if (shouldCreateNew || !obj) {
          obj = new Plan();
          obj.set('username', username);
        }
        
        // 设置奖项数据
        obj.set('prizesJson', JSON.stringify(prizes));
        
        // 保存（LeanCloud 会在首次保存时自动创建表，前提是权限允许）
        await obj.save();
        alert('预设奖项已保存');
        adminLoadPresetList();
      } catch (e) {
        console.error('adminSavePresetPrizes error:', e);
        let errorMsg = '保存失败：' + (e.message || e);
        if (e.code === 403) {
          errorMsg += '\n\n提示：请检查 LeanCloud 控制台中 UserPrizePlan 表的权限设置，确保允许创建和更新数据。';
        } else if (e.code === 404) {
          errorMsg += '\n\n提示：表不存在。请先在 LeanCloud 控制台手动创建 UserPrizePlan 表，或检查权限设置是否允许自动创建表。';
        }
        alert(errorMsg);
      }
    }

    async function adminLoadPresetList() {
      const wrap = document.getElementById('adminPresetList');
      if (!wrap) return;
      wrap.innerHTML = '<div class="loading">加载中...</div>';
      try {
        const Plan = AV.Object.extend('UserPrizePlan');
        const query = new AV.Query(Plan);
        query.limit(200);
        query.ascending('username');
        const results = await query.find();
        if (!results.length) {
          wrap.innerHTML = '<div class="empty-records">暂无预设奖项</div>';
          return;
        }
        const rows = results.map((r) => {
          const u = r.get('username') || '';
          const raw = r.get('prizesJson') || '[]';
          let arr;
          try {
            arr = JSON.parse(raw);
          } catch {
            arr = [];
          }
          const txt = Array.isArray(arr) ? arr.join('，') : '';
          return `<tr>
            <td>${escapeHtml(u)}</td>
            <td>${escapeHtml(txt)}</td>
            <td>
              <button type="button" class="admin-link-btn" onclick="adminEditPreset('${u}')">修改</button>
              <button type="button" class="admin-link-btn danger" onclick="adminDeletePreset('${u}')">删除</button>
            </td>
          </tr>`;
        }).join('');
        wrap.innerHTML = '<table class="admin-table"><thead><tr><th>用户</th><th>预设奖项（顺序）</th><th>操作</th></tr></thead><tbody>' + rows + '</tbody></table>';
      } catch (e) {
        // 404 表示表不存在，显示空列表
        if (e.code === 404 || e.status === 404) {
          wrap.innerHTML = '<div class="empty-records">暂无预设奖项（表尚未创建）</div>';
        } else {
          console.error('adminLoadPresetList error:', e);
          wrap.innerHTML = '<div class="empty-records">加载失败：' + (e.message || e) + '</div>';
        }
      }
    }

    async function adminDeletePreset(username) {
      if (!confirm('确定删除该用户的预设奖项？')) return;
      try {
        const Plan = AV.Object.extend('UserPrizePlan');
        const query = new AV.Query(Plan);
        query.equalTo('username', username);
        const obj = await query.first();
        if (obj) await obj.destroy();
        adminLoadPresetList();
      } catch (e) {
        // 404 表示表不存在或记录不存在，视为删除成功
        if (e.code === 404 || e.status === 404) {
          adminLoadPresetList();
        } else {
          alert('删除失败：' + (e.message || e));
        }
      }
    }

    async function adminEditPreset(username) {
      // 将该用户的预设奖项加载到上方表单中，便于修改
      try {
        const Plan = AV.Object.extend('UserPrizePlan');
        const query = new AV.Query(Plan);
        query.equalTo('username', username);
        const obj = await query.first();
        if (!obj) {
          alert('该用户暂无预设奖项');
          return;
        }
        const raw = obj.get('prizesJson') || '[]';
        let arr;
        try {
          arr = JSON.parse(raw);
        } catch {
          arr = [];
        }
        const usernameInput = document.getElementById('adminPresetUsername');
        if (usernameInput) usernameInput.value = username;
        adminInitPresetPrizeOptions();
        const selects = document.querySelectorAll('.preset-prize-select');
        selects.forEach((sel, idx) => {
          sel.value = arr[idx] || '';
        });
      } catch (e) {
        // 404 表示表不存在或记录不存在
        if (e.code === 404 || e.status === 404) {
          alert('该用户暂无预设奖项');
        } else {
          console.error('adminEditPreset error:', e);
          alert('加载失败：' + (e.message || e));
        }
      }
    }

    async function adminLoadRecords() {
      const listEl = document.getElementById('adminRecordsList');
      const username = document.getElementById('adminRecordsUsername').value.trim();
      listEl.innerHTML = '<div class="loading">加载中...</div>';
      try {
        const DrawRecord = AV.Object.extend('DrawRecord');
        const query = new AV.Query(DrawRecord);
        query.notEqualTo('isDeveloper', true);
        if (username) query.equalTo('username', username);
        query.descending('drawTime');
        query.limit(200);
        const results = await query.find();
        if (results.length === 0) {
          listEl.innerHTML = '<div class="empty-records">暂无记录</div>';
          return;
        }
        const rows = results.map((r) => {
          const id = r.id;
          const u = r.get('username') || '';
          const prize = r.get('prize') || '';
          const time = r.get('drawTime');
          const timeStr = time ? formatDateTime(time instanceof Date ? time : new Date(time)) : '';
          return `<tr data-id="${id}">
            <td>${escapeHtml(u)}</td><td>${timeStr}</td><td>${escapeHtml(prize)}</td>
            <td>
              <button type="button" class="admin-link-btn" onclick="adminEditRecord('${id}')">修改</button>
              <button type="button" class="admin-link-btn danger" onclick="adminDeleteRecord('${id}')">删除</button>
            </td>
          </tr>`;
        }).join('');
        listEl.innerHTML = '<table class="admin-table"><thead><tr><th>用户</th><th>时间</th><th>奖项</th><th>操作</th></tr></thead><tbody>' + rows + '</tbody></table>';
      } catch (e) {
        listEl.innerHTML = '<div class="empty-records">加载失败：' + (e.message || e) + '</div>';
      }
    }

    async function adminDeleteRecord(objectId) {
      if (!confirm('确定删除这条记录？')) return;
      try {
        const DrawRecord = AV.Object.extend('DrawRecord');
        const obj = AV.Object.createWithoutData('DrawRecord', objectId);
        await obj.destroy();
        alert('已删除');
        adminLoadRecords();
      } catch (e) {
        alert('删除失败：' + (e.message || e));
      }
    }

    async function adminEditRecord(objectId) {
      const newPrize = prompt('请输入新的奖项名称（如：10元、谢谢参与）');
      if (newPrize == null || newPrize.trim() === '') return;
      try {
        const obj = AV.Object.createWithoutData('DrawRecord', objectId);
        obj.set('prize', newPrize.trim());
        await obj.save();
        alert('已修改');
        adminLoadRecords();
      } catch (e) {
        alert('修改失败：' + (e.message || e));
      }
    }

  </script>
</body>

</html>
